# SRT字幕品質改善提案

**作成日**: 2025-11-25
**対象**: two_pass.py（Pass1〜Pass4ワークフロー）
**目的**: 日本語テロップとして自然で読みやすいSRT出力を実現する

---

## 📊 現状の問題分析

### 実際のSRT出力レビュー結果

**評価対象**: `output/sample_audio3_mlx_20251124T192537.srt`
**総合スコア**: 3 / 5
**判定**: 要修正

### 検出された主要な問題

#### 1. 極端に短い行（1〜4文字）
```
❌ 悪い例:
「んで」（2文字のみ）
「から」（2文字のみ）
「よ」（1文字のみ）
「に」（1文字のみ）

※ これらは視認性が低く、読みにくい
```

#### 2. 重要な固有名詞の誤変換
```
❌ 例:
55行目: 「岸田さん、石川さん」→ 正しくは「石破さん」
367行目: 「安政党さん」→ 正しくは「参政党」
275行目: 「ぜぜひひなんですけれども」→ 正しくは「是々非々」
```

#### 3. 句読点削除の不徹底
- 行末の句読点が残っている箇所が複数存在

**注**: 音声認識の一般的な誤変換（意味不明な箇所）は、LLMが勝手に判断して暴走するリスクがあるため、自動修正の対象外とする。固有名詞のみ慎重に対応。

---

## 🔧 具体的な改善案

### 改善案1: validators.py の検証ルール追加

**現状**: 2つのルールのみ
- 5文字未満で助詞で終わる行
- 引用表現「〜って言う/思う」の分割

**問題点**:
- 極端に短い行（1〜4文字）がチェックされていない
- 句読点削除のチェックなし

**提案**: 以下のルールを追加

```python
# 追加すべき検証ルール

1. 極端に短い行（1〜4文字）を検出
   対象: すべての行（助詞・非助詞問わず）
   → 前後と統合して5文字以上に

   例: 「んで」（2文字）、「よ」（1文字）、「に」（1文字）など

2. 行末の句読点（。、）が残っている行を検出
   → 句読点を削除
```

**効果**:
- 視認性の低い極端に短い行を削減
- 句読点削除を確実に実施

---

### 改善案2: Pass1のプロンプトに固有名詞チェックを追加

**現状**: 一般的な誤変換のみを対象

**提案**: プロンプトに以下を追加

```
# 固有名詞チェックの追加項目

- 政治家・政党名・地名など固有名詞は特に注意してチェック
- 一般的な誤変換例：
  * 石川→石破、安政党→参政党、賛成党→参政党
  * 数字や人名の取り違えに注意
  * 日付・金額などの数値情報は慎重に確認
- 文脈を考慮して、明らかにおかしい変換を修正
- 専門用語・カタカナ語の誤変換もチェック
```

**効果**:
- 「石川さん」→「石破さん」などの重要な誤変換を修正
- 内容的な致命的ミスを大幅に削減

---

### 改善案3: Pass4の後に句読点削除パスを追加 ★即効性あり

**現状**:
- 句読点削除がPass2/Pass3/Pass4のプロンプトに書かれているが、実際には削除されていない
- LLMが他のタスクに集中し、句読点削除を忘れる

**提案A**: 正規表現による確実な削除（推奨）
```python
def _strip_trailing_punctuation(lines: List[LineRange]) -> List[LineRange]:
    """行末の句読点を削除（LLM不要）"""
    for line in lines:
        line.text = line.text.rstrip("。、")
    return lines
```

**提案B**: 軽量なLLMチェック
- ごく軽量なプロンプトで最終確認
- コストは微増だが、確実性が高い

**実装箇所**:
- Pass4の後、`_ranges_to_segments()` の前に実行

**効果**:
- 確実に句読点を削除でき、コストもほぼゼロ
- すぐに実装でき、即座に効果が出る

---

## 📈 推奨実装順序

### Phase 1: 即効性のある改善（1日）
1. **改善案3（句読点削除パス）** ← すぐに効果が出る、コストゼロ
2. **改善案1（検証ルール追加）** ← 極端に短い行を検出・修正

### Phase 2: 根本的な品質向上（1〜2日）
3. **改善案2（固有名詞チェック）** ← 致命的な誤変換を削減

---

## 🎯 期待される効果

### 改善前（現状）
- 総合スコア: 3 / 5
- 判定: 要修正
- 致命的なミス: 3件（固有名詞誤変換、意味不明な箇所）
- 主な問題: 極端に短い行、句読点削除漏れ

### 改善後（Phase 1完了時）
- 総合スコア: 4 / 5（推定）
- 判定: 合格
- 致命的なミス: 2〜3件（固有名詞誤変換のみ）
- 改善点: 極端に短い行が削減、句読点削除が徹底

### 改善後（Phase 2完了時）
- 総合スコア: 4.5〜5 / 5（推定）
- 判定: 合格〜優秀
- 致命的なミス: 0件
- 改善点: 固有名詞誤変換も大幅に削減

---

## 📝 補足: 各Passの役割再確認

```
Pass1（誤字修正）
  ↓ 音声認識の誤変換を修正（replace/delete）
  ↓ 改善案2で固有名詞チェックを強化

Pass2（行分割）
  ↓ 17文字以内で自然な行に分割
  ↓ ※ 助詞での分割は許容される

validators.py（問題検出）← 改善案1で追加
  ↓ Pass2の出力を自動チェック
  ↓ 極端に短い行（1〜4文字）を検出

Pass3（問題修正）
  ↓ 検出された問題を修正
  ↓ 短い行を統合して5文字以上に

Pass4（長さ超過修正）
  ↓ 17文字超 or 5文字未満の行を再分割

句読点削除 ← 改善案3で新規追加
  ↓ 行末の句読点を確実に削除（正規表現）

最終出力（SRT）
```

---

## 🔗 関連ドキュメント

- `src/llm/two_pass.py`: メインワークフロー実装
- `src/llm/validators.py`: 検証ロジック
- `docs/specs/llm_two_pass_workflow.md`: ワークフロー仕様
- `docs/reports/srt_feedback_20251123.md`: 過去のフィードバック

---

## 📅 次のアクション

1. このドキュメントをレビュー ✅
2. Phase 1の実装を開始
   - 改善案3: 句読点削除パスの追加（優先）
   - 改善案1: validators.py に短い行検出を追加
3. テスト音声で効果を検証
4. Phase 2の実装（改善案2: 固有名詞チェック）
