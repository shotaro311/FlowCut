# プランニングドキュメント：LLMプロンプトワークフロー切り替え機能追加

**作成日**: 2025-11-25  
**バージョン**: 1.0  
**ステータス**: ドラフト  
**前バージョンからの変更**: 新規作成（ワークフロー1/2切り替えによるプロンプト比較実験用）

※このPLANは、ユーザーからの依頼に基づき作成しています。既存の OpenAI SRT バグ修正PLAN（`docs/plan/20251124_PLAN1.md`）とは独立した新しいタスクです。

---

## ⚡ クイックリファレンス（引き継ぎ用）

> 新規エージェントが3分で状況を把握するためのサマリー

**目的**:  
LLMプロンプトの「旧版（現行 two_pass.py）」と「改善案（`docs/reports/prompt_improvement_proposal_20251125.md`）」を、CLIレベルで簡単に切り替えながら比較できるようにする。  

**やりたいこと**:  
- `python -m src.cli.main run ... --workflow workflow1`  
- `python -m src.cli.main run ... --workflow workflow2`  
のように指定するだけで、
  - Workflow1: 現在のプロンプトセット（従来版）  
  - Workflow2: 改善提案ドキュメントにもとづく新プロンプトセット  
を切り替えて実行できるようにする。

**現在地**: 設計前（要件整理とインターフェース案の検討段階）  
**次のアクション**: 本PLANで仕様・設計方針を固めたうえで、CLIオプション・TwoPassFormatter・prompts.py の責務分割を決める。  
**ブロッカー**: なし（既存コードを読む必要はあるが、外部サービス要件は既に満たされている前提）。  

### フェーズ進捗（このPLAN内）
- [ ] Phase 0: 目的・要件・制約の整理  
- [ ] Phase 1: 設計（インターフェースと内部構造）  
- [ ] Phase 2: 実装方針の具体化（どのファイルをどう変えるか）  
- [ ] Phase 3: テスト・比較手順の整理  

---

## 🎯 このタスクで実現したいこと

### ゴールイメージ

非エンジニアのユーザーでも、次のように簡単に「旧プロンプト」と「改善プロンプト」を切り替えて比較できる:

- 従来ワークフロー（Workflow1）:
  ```bash
  python -m src.cli.main run samples/sample_audio.m4a --llm google --workflow workflow1
  ```
- 改善ワークフロー（Workflow2）:
  ```bash
  python -m src.cli.main run samples/sample_audio.m4a --llm google --workflow workflow2
  ```

CLIオプションの違いだけで、
- TwoPassFormatter が参照するプロンプトセット（Pass1〜Pass4の指示文）  
- それに付随するローカルロジック（文字数チェック、短すぎる行の扱い、validators による検査ルール など）  
が切り替わり、出力されるSRTの品質や処理時間を比較しやすくなることを目指す。

### スコープ

**このPLANで対象とすること**
- CLIレベルで「ワークフロー名を指定できるオプション」を追加すること  
  - 例: `--workflow {workflow1,workflow2}`（短縮形 `-W` などは別途検討）  
- TwoPassFormatter／prompts＋その直近のロジック（Pass1〜Pass4 のプロンプトと、それに紐づく文字数チェック・短い行検出・validators 等）で、
  - Workflow1 = 現状の挙動一式（プロンプト＋文字数ルール＋validators）  
  - Workflow2 = `docs/reports/prompt_improvement_proposal_20251125.md` に沿った改善案一式  
  を切り替えられるようにする設計を決めること。  
- 「デフォルトは今まで通り（Workflow1）」とし、オプションを指定しない限り挙動を変えないこと。

**このPLANのスコープ外（別タスク扱い）**
- 新しい LLM プロバイダやモデルの追加  
- LLM整形以外のパイプライン（音声認識ランナーやSRTファイル書き出しロジック）の切り替え  
- GUI（フロントエンド）側でのワークフロー切り替えUI実装  

---

## 🧱 現状整理（関連ファイル）

- `src/cli/main.py`  
  - Typer ベースの CLI。現在は `--llm` や `--llm-profile` などのオプションを受け取り、`PocRunOptions` に詰めて `execute_poc_run` を呼び出している。
- `src/pipeline/poc.py`  
  - `PocRunOptions` を受け取り、`TwoPassFormatter` を初期化している。  
  - 現状は「どのプロンプトを使うか」を切り替える仕組みはなく、TwoPassFormatter の内部実装に依存。
- `src/llm/two_pass.py`  
  - Pass1〜Pass4 のプロンプト生成メソッド（`_build_pass1_prompt` / `_build_pass2_prompt` / `_build_pass3_prompt` / `_build_pass4_prompt`）を持つ。  
  - ここに、`docs/reports/prompt_improvement_proposal_20251125.md` に書かれた改善版コード例が対応する。
- `docs/reports/prompt_improvement_proposal_20251125.md`  
  - Pass1〜Pass3の改善版プロンプト案と、その設計方針・優先順位が整理されている。  
  - Workflow2（改善ワークフロー）の仕様書として扱う予定。

---

## 🏗 設計方針（ドラフト）

### 1. ワークフローの定義

まずは、ワークフローをシンプルな名前で定義する:

- `workflow1`: 現行のプロンプト実装（two_pass.py に既にあるもの）  
- `workflow2`: 改善案に基づいた新プロンプト実装  

将来的に `workflow3` 以降を追加しやすいよう、文字列スラッグとして扱う（enum的なイメージ）。

### 2. CLI インターフェース案

- オプション名案:
  - 第一候補: `--workflow`（値: `"workflow1"`, `"workflow2"`）  
  - 省略時: `"workflow1"` を暗黙的に利用（= 互換性維持）  
  - エンジニア以外にも分かりやすくするため、ヘルプ文言で「プロンプトセットの切り替え」だと説明する。

例:
```bash
python -m src.cli.main run samples/sample_audio.m4a --llm google --workflow workflow2
```

### 3. オプションの伝播経路

1. `src/cli/main.py`
   - Typer の `@app.command()` に `workflow: Optional[str]` オプションを追加。  
   - `_normalize_workflow` のようなヘルパーで、`None` → `"workflow1"` に正規化しつつ、未知の値はエラーにする。
2. `PocRunOptions`（`src/pipeline/poc.py`）
   - `workflow: str | None = None` のようなフィールドを追加し、CLIの値を格納。  
3. `execute_poc_run` 内で TwoPassFormatter を生成する部分
   - `TwoPassFormatter(..., workflow=options.workflow or "workflow1", ...)` のように渡す。  
4. `TwoPassFormatter`（`src/llm/two_pass.py`）
   - `__init__` に `workflow: str = "workflow1"` を追加。  
   - `_build_pass1_prompt` / `_build_pass2_prompt` / `_build_pass3_prompt` などで、`self.workflow` に応じて「旧版プロンプト or 改善版プロンプト」を呼び分ける。

### 4. プロンプト／整形ロジック実装の切り替え戦略

実装パターン案（どれか1つに絞る想定）:

1. **two_pass.py 内で if 分岐**  
   - 例:  
     ```python
     if self.workflow == "workflow2":
         return _build_pass1_prompt_v2(...)
     else:
         return _build_pass1_prompt_v1(...)
     ```  
   - メリット: 影響範囲が局所的で分かりやすい。  
   - デメリット: two_pass.py が少し長くなる。

2. **`src/llm/prompts.py` に「ワークフロー別プロンプト」を切り出す**  
   - 例: `get_pass1_prompt(workflow, ...)` のようなAPIにして、内部で workflow ごとに切り替える。  
   - メリット: プロンプトロジックを1ファイルに集約でき、複数ワークフローの管理がしやすい。  
   - この案は「今後 workflow3 以降も増えそう」なら有力。

このPLANでは、**(2) prompts.py に集約して workflow 引数で切り替える** 方針を第一候補とする（保守性重視）。  
あわせて、文字数チェックや validators のルールなど「Pass1〜Pass4 間のプログラム的な整形ロジック」も、workflow ごとに切り替えられるように設定オブジェクト等でまとめて管理する。

---

## 🧪 比較・テスト方針（概要）

### 手動比較のイメージ

同じ音声ファイルに対して、次のように実行して差分を見る:

```bash
# Workflow1（従来プロンプト）
python -m src.cli.main run samples/sample_audio.m4a --llm google --workflow workflow1

# Workflow2（改善版プロンプト）
python -m src.cli.main run samples/sample_audio.m4a --llm google --workflow workflow2
```

- 出力先 SRT ファイル名 (`output/{run_id}.srt`) を比較し、  
  - 行ごとの長さ（5〜17文字の範囲か）  
  - 極端に短い行の有無  
  - 読みやすさ（主観評価）  
を確認する。  
- 余裕があれば、`logs/metrics/*_metrics.json` を見て、Pass3 の処理時間・トークン数の差も比較する。

### 自動テストの方向性（このPLANでは概要のみ）

- `tests/test_two_pass_workflow_switching.py`（仮）を追加し、
  - workflow1 と workflow2 の両方で TwoPassFormatter を呼び出した際に、  
    - エラーにならないこと  
    - 少なくとも「全文カバー（全文が行に割り当てられていること）」は維持されていること  
  を確認する。  
- プロンプトの細かい内容（日本語の自然さ）は自動化が難しいため、このPLANでは「行数・長さ・全文カバー」に絞る。

---

## 📌 今後の実装ステップ（ドラフト）

※ここに書くのは「実装する時のToDo」であり、このメッセージ時点ではまだ手を付けない。

1. **Phase 1: CLIオプション追加**
   - [ ] `src/cli/main.py` に `--workflow` オプションを追加し、`PocRunOptions` に渡す。  
   - [ ] `--workflow` 未指定時は `"workflow1"` を使うように正規化。  

2. **Phase 2: TwoPassFormatter と prompts の拡張**
   - [ ] `PocRunOptions` に `workflow` フィールドを追加し、`execute_poc_run` → `TwoPassFormatter` に渡す。  
   - [ ] `TwoPassFormatter.__init__` に `workflow` 引数を追加。  
   - [ ] `src/llm/prompts.py` に「workflow を受け取ってプロンプト文字列を返す」関数群を追加し、two_pass.py から呼び出す形にリファクタ。  
   - [ ] Workflow1 には現行プロンプト、Workflow2 には改善版プロンプト（本レポートに記載）を対応付ける。

3. **Phase 3: テスト・比較**
   - [ ] 簡単なユニットテストを追加し、`workflow1` / `workflow2` それぞれで TwoPassFormatter が動くことを確認。  
   - [ ] サンプル音声で実際に両ワークフローを実行し、SRTとメトリクスを目視比較。  

---

## 🧾 メモ / TODO

- TODO: `--workflow` の名称と値（`workflow1` / `workflow2`）は、ユーザーと相談のうえ分かりやすい名前（例: `baseline` / `proposal_20251125`）に変更する可能性あり。  
- TODO: 今後 workflow が増えた場合を見据えて、`src/llm/prompts.py` 側では辞書マッピング（`{"workflow1": PromptSetV1, "workflow2": PromptSetV2}` のような構造）で管理する案も検討する。  
