# プランニングドキュメント：Workflow切替リファクタ＋Workflow2 Pass3校正（Glossary）導入

**作成日**: 2025-12-15  
**バージョン**: 1.0  
**ステータス**: 実装完了（Draft PR作成済み、レビュー待ち）  
**前バージョンからの変更**: 新規作成

※初めて作業に取り掛かる場合は、必ずこのプランドキュメントと別にある要件定義書（`docs/requirement.md`）にも目を通してください。実装時はGit差分も確認します。

承認: 2025-12-15 by @shotaro311

---

# 進捗状況

## ⚡ クイックリファレンス

**現在地**: Phase 3 - テスト/ドキュメント同期（完了）  
**次のアクション**: Draft PRレビュー → マージ（base=`feat/srt-gap-fill`）  
**ブロッカー**: なし  
**PR**: #14 Draft（base=`feat/srt-gap-fill` / head=`feat/workflow2-proofread-glossary`）  
https://github.com/shotaro311/FlowCut/pull/14  
**重要な決定事項**:
- 「フロー（Passの順番・役割）は変えない」
- Workflow2 Pass3は**常時実行**し、出力は `lines(JSON)` のまま（`from/to` は変更しない）
- Glossaryは**アプリ全体で共通**にし、GUIの「辞書」から任意編集できるようにする

### フェーズ進捗
- [x] Phase 0: 仕様確定
- [x] Phase 1: Workflow切替リファクタ（重複/死コード整理）
- [x] Phase 2: Workflow2 Pass3へGlossary校正プロンプト導入
- [x] Phase 3: テスト追加/更新＋ドキュメント同期（requirement/PLAN）
- [x] Phase 4: PR作成（Draft）

### 重要なファイルパス（今回触る可能性が高い）
- LLMパイプライン起点: `src/pipeline/poc.py`
- TwoPass（workflow1/2）: `src/llm/two_pass.py`
- TwoPass（workflow2最適化版）: `src/llm/two_pass_optimized.py`
- Pass3の検出器: `src/llm/validators.py`
- Pass5（任意）: `src/llm/pass5_processor.py`
- GUIヘッダー（ボタン追加）: `src/gui/app.py`
- GUI設定保存（`~/.flowcut/config.json`）: `src/gui/config.py`
- 要件定義: `docs/requirement.md`

---

## 🔄 現在の作業状態

**最終更新**: 2025-12-15  
**進捗率**: 100%

### 直前の作業
- ✅ 完了: workflow2 Pass3へ校正プロンプト（Glossary込み）を組み込み
- ✅ 完了: GUIに「辞書」ボタン追加（`~/.flowcut/config.json` に保存）
- ✅ 完了: `two_pass_optimized.py` の重複削減（`two_pass.py` を再利用）
- ✅ 完了: テスト追加＋ `docs/requirement.md` / `docs/README.md` を同期
- ✅ 完了: Draft PR作成（base=`feat/srt-gap-fill`）
- ⏳ 次のタスク: PRレビュー → マージ

---

# 要件概要

## 背景・目的

- Workflow1/2の切替に関連する実装が複数箇所にあり、重複・不要コードが混在しやすい。
- Workflow2のPass3で「字幕の校正（誤字脱字/固有名詞統一/政治用語の表記統一）」を行いたい。
- 固有名詞の揺れを運用で直せるように、**Glossaryをアプリ上から任意編集できる**ようにしたい。

## 実装する機能（今回やること）

1. **Workflow切替まわりのリファクタリング**
   - 目的: 重複コード/死コード/分岐の複雑さを整理する
   - 制約: **出力や処理フロー（Pass順・役割）は変えない**

2. **アプリに「辞書（Glossary）」ボタンを追加し、用語を任意編集できるようにする**
   - 目的: 利用者が固有名詞の表記を調整できるようにする
   - 仕様案: 「辞書」ボタン → 1行1語の編集ダイアログ → `~/.flowcut/config.json` に保存

3. **Workflow2のPass3に、指定プロンプト（Glossary付き）の校正指示を埋め込む**
   - 目的: SRTのテキスト品質（誤字脱字/固有名詞/政治用語）を改善する
   - 制約: **タイムコード（= from/toに対応する範囲）を変えない**

## スコープ外（今回やらないこと）

- 新しいLLMプロバイダー追加、外部検索API（Wikipedia取得など）の実装
- Pass1/Pass2/Pass4/Pass5の役割変更（ただし安全のための軽微な検証は追加する可能性あり）
- UIの大幅改修

---

# 既存構成（初心者向けに超要約）

## 現行フロー（重要）

- **Pass1**（誤変換の最小修正）: `operations(JSON)` を返す
- **Pass2**（行分割）: `lines(JSON)` を返す（from/to/text）
- **Pass3**（検証＆最小修正）: issues を見て `lines(JSON)` を返す（現在はWorkflow差あり）
- **Pass4**（長さ違反行のみ再分割）: 違反行だけをLLMで直す
- **Pass5**（任意）: 生成済みSRTの「長い行」だけ改行する

※SRTのタイムコードは、最終的に `from/to` の範囲を word timestamp にマップして生成される（LLMが直接タイムコードを書き換える構成ではない）。

---

# 決定事項（確定済み）

ユーザー回答により、以下で確定。

1. **Workflow2 Pass3の“校正”は常時実行**（A）

2. **Pass3の出力形式は `lines(JSON)` のまま**（A）
   - 方針: `from/to`（範囲）は変更しない。`text` のみ校正する。

3. **「辞書（Glossary）」はアプリ全体で共通**（A）
   - GUIの「辞書」ボタンから編集し、`~/.flowcut/config.json` に保存する。

---

# アーキテクチャ設計（今回の方針）

## 方針1：Workflow切替の整理（フロー不変）

- `two_pass.py` と `two_pass_optimized.py` の **差分（本当に必要な違い）** を先に明文化する
- その上で、次のどちらかで整理する（Phase 1で確定）
  - **案A（低リスク）**: 2ファイルは残しつつ、共通処理を整理して“分岐の責務”を明確化（重複の削減）
  - **案B（中リスク）**: 実装を1本化して、workflowのフラグ/設定で差分を吸収（テストで回帰防止）

## 方針2：Workflow2 Pass3の校正プロンプト導入（フロー不変）

- Pass3は「from/to（範囲）は固定、textのみ校正」を原則にする
- Glossaryは **アプリ設定（`~/.flowcut/config.json`）から読み込み**、プロンプトに展開する（未設定時はデフォルト辞書を使用）
- 「政治用語の公式表記」は **“確信がある時だけ”** を基本方針として、誤修正を抑える（迷う場合は変更しない）

---

# 実装フェーズ

## Phase 0: 仕様確定（当日）
- [x] 「確認事項（最大3つ）」の回答をもらう（A/A/A）
- [x] リファクタ方針（案A/案B）を確定する（案A: `two_pass.py` 再利用で重複削減）
- [x] 完了条件を最終確定

## Phase 1: Workflow切替リファクタ（重複/死コード整理）
- [x] `src/pipeline/poc.py` の workflow2分岐で `glossary_terms` を渡すように整理
- [x] `src/llm/two_pass_optimized.py` を薄くし、`src/llm/two_pass.py` を再利用する構成へ変更（重複削減）
- [x] 既存テストが落ちないことを確認（回帰防止）

## Phase 2: Workflow2 Pass3へGlossary校正プロンプト導入
- [x] GUIに「辞書」ボタンを追加し、Glossaryを編集・保存できるようにする（`~/.flowcut/config.json`）
- [x] Workflow2 Pass3のプロンプトに、ユーザー指定の校正指示＋Glossaryを組み込む
- [x] Pass3が workflow2 で `from/to` を変更した場合は採用しないガードを追加（タイムコード維持）

## Phase 3: テスト追加/更新＋ドキュメント同期
- [x] テスト追加: GUIのGlossary保存/読込（`tests/test_glossary_config.py`）
- [x] テスト追加: workflow2 Pass3プロンプトにGlossaryが含まれる（`tests/test_workflow2_pass3_proofread_prompt.py`）
- [x] `docs/requirement.md` / `docs/README.md` を最新実装に同期

---

# リスクと対応策

- **LLMがGlossaryにない固有名詞を誤って変える**  
  → 「迷う場合は変更しない」をプロンプトで明記し、変更を最小限にする
- **辞書（Glossary）の設定が空/壊れていて意図しない挙動になる**  
  → 形式チェック（1行1語、空行除外）＋ 読み込み失敗時はデフォルト辞書にフォールバック
- **Pass3出力がフォーマット崩れでパース失敗する**  
  → 既存同様にフォールバック（Pass2出力）＋テストで担保
- **リファクタで挙動が変わる**  
  → “フロー不変”を完了条件に入れ、差分が出たら即戻せるように小さなパッチで進める

---

# 完了条件

## 機能要件
- [ ] Workflow1/2の処理フロー（Pass順・役割）が現状から変わっていない
- [ ] Workflow2 Pass3で、誤字脱字/Glossary統一/政治用語表記統一が意図どおり効く
- [ ] タイムコード（= from/toの範囲）は変えない（少なくともPass3で範囲を変更しない）
- [ ] GUIからGlossaryを編集・保存でき、次回以降の処理に反映される

## 品質要件
- [ ] 既存テストが全て通る
- [ ] 追加したテストが通る

## ドキュメント
- [ ] `docs/requirement.md` の記述が実装と矛盾しない（矛盾がある場合はTODOで明示）
- [ ] このPLANが最新状態になっている
