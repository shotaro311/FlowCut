# Pass1〜Pass3 プロンプト改善提案

**作成日**: 2025-11-25
**対象**: two_pass.py の各Passプロンプト
**目的**: 精度を維持しつつ、処理速度を向上させる

---

## 📋 改善の全体方針

### 考慮する改善項目
1. **改善案1**: validators.py に極端に短い行（1〜4文字）と句読点検出を追加
2. **改善案2**: Pass1に固有名詞チェックを追加（慎重に）
3. **改善案3**: 句読点削除パスを追加（Pass4後に正規表現で実行）
4. **プロンプト最適化**: indexed短縮、ルール簡潔化

**注**: AIモデルは変更しません（ユーザー指定のモデルを使用）

### 各Passの役割分担（明確化）

```
Pass1: 誤字修正
  ↓ 音声認識の明らかな誤変換のみを修正
  ↓ 固有名詞は慎重に（文脈が明確な場合のみ）
  ↓ 意訳・要約は厳禁

Pass2: 行分割
  ↓ 5〜17文字の範囲で自然な行に分割（厳守）
  ↓ 極端に短い行（1〜4文字）は絶対に作らない
  ↓ 17文字超過は絶対に許容しない（前後文脈で再分割）
  ↓ 助詞での分割は許容

validators.py: 問題検出
  ↓ 極端に短い行（1〜4文字）を検出
  ↓ 引用表現の分割を検出

Pass3: 問題修正
  ↓ 検出された問題のみを最小限で修正
  ↓ 17文字超過の行は前後文脈で再分割（厳守）
  ↓ 全行を再確認するが、問題がない行はそのまま
  ↓ 意訳・要約は厳禁

Pass4: 長さ超過修正
  ↓ 17文字超 or 5文字未満の行を再分割（厳守）

句読点削除（新規）
  ↓ 正規表現で確実に削除

最終出力（SRT）
```

---

## 🔧 Pass1 プロンプト改善案

### 改善ポイント
1. ✅ **固有名詞チェックの追加**（改善案2）
   - 有名な固有名詞に限定
   - 文脈が明確な場合のみ修正
   - 過剰な介入を防ぐため慎重に

2. ✅ **意訳・要約の厳禁を強調**
   - LLMの暴走を防ぐ
   - 音声に無い単語を追加しない

3. ✅ **修正の最小化を強調**
   - 明らかな誤変換のみ修正
   - 判断が難しい場合は修正しない

### 改善版プロンプト

```python
def _build_pass1_prompt(self, raw_text: str, words: Sequence[WordTimestamp]) -> str:
    indexed = _build_indexed_words(words)
    return (
        "あなたはプロの字幕エディターです。以下の単語列を順番を変えずに、"
        "**明らかな誤変換のみ**最小限の修正を加えてください。\n\n"

        # --- 改善1: 許可される操作を明確化 ---
        "# 許可される操作\n"
        "- **replace**: 明らかな誤変換を正しい語に置き換え\n"
        "- **delete**: 明らかなノイズ（フィラー、重複）を削除\n"
        "- **禁止**: 挿入（音声に無い単語を追加しない）、並び替え、要約、意訳\n\n"

        # --- 改善2: 固有名詞チェックの追加（慎重に） ---
        "# 特に注意すべき誤変換（文脈が明確な場合のみ修正）\n"
        "1. **有名な固有名詞**（政治家・地名・企業名・政党名）\n"
        "   - 文脈から明らかに誤変換と判断できる場合のみ修正\n"
        "   - 例: 政治の話で「石川」→「石破」、「安政党」→「参政党」\n"
        "   - 判断が難しい場合は修正しない（人名の誤認識リスクを避ける）\n\n"

        "2. **一般的な誤変換パターン**\n"
        "   - 同音異義語の明らかな誤り（例: 「会う」→「合う」）\n"
        "   - カタカナ語の誤変換（例: 「コンピューター」→「コンピュータ」）\n\n"

        # --- 改善3: 禁止事項を最上部に強調 ---
        "# 禁止事項（厳守）\n"
        "- 意訳・要約・言い換えは絶対に禁止\n"
        "- 音声に無い単語を追加しない\n"
        "- 単語の順序を変えない\n"
        "- 判断が難しい場合は修正しない（保守的に）\n\n"

        f"# 入力\n"
        f"元のテキスト:\n{raw_text}\n\n"
        f"単語リスト（index:word）:\n{indexed}\n\n"

        "# 出力\n"
        "以下のJSON形式のみを返してください。説明文・コードフェンスは禁止。\n"
        '{\n'
        '  "operations": [\n'
        '    {"type": "replace", "start_idx": 10, "end_idx": 11, "text": "石破"},\n'
        '    {"type": "delete", "start_idx": 25, "end_idx": 25}\n'
        '  ]\n'
        '}\n'
        "操作が不要な場合は空配列を返してください: {\"operations\": []}\n"
    )
```

### 変更点サマリ
| 項目 | 変更前 | 変更後 | 理由 |
|------|--------|--------|------|
| 固有名詞チェック | なし | 追加（慎重に） | 改善案2 |
| 禁止事項の強調 | 末尾に記載 | 最上部に移動 | LLMの暴走防止 |
| 操作の明確化 | 簡潔 | 詳細化 | 過剰な修正を防ぐ |
| 空配列の指示 | なし | 追加 | 修正不要時の明確化 |

---

## 🔧 Pass2 プロンプト改善案

### 改善ポイント
1. ✅ **極端に短い行の禁止を強調**（改善案1対応）
   - 1〜4文字の行は絶対に作らない
   - 最低5文字以上を厳守

2. ✅ **プロンプトの簡潔化**（Phase 1）
   - 冗長な説明を削減
   - 禁止事項を最上部に
   - 例を1つに統合

3. ✅ **句読点削除の明記**（改善案3対応）
   - 行末の句読点削除を強調
   - ただし後段で正規表現で確実に削除するため、過度に強調しない

### 改善版プロンプト

```python
def _build_pass2_prompt(self, words: Sequence[WordTimestamp], *, max_chars: float) -> str:
    indexed = _build_indexed_words(words)
    return (
        # --- 改善1: Roleを簡潔に ---
        "# Role\n"
        "あなたは熟練の動画テロップ編集者です。\n"
        "以下の単語リストを、視聴者が読みやすいように行分割してください。\n\n"

        # --- 改善2: 禁止事項を最上部に（最重要ルール） ---
        "# 最重要ルール（これを破ったら即アウト）\n"
        "1. **極端に短い行（1〜4文字）を作らない**\n"
        "   - 最低5文字以上必須（例: 「よ」「に」「んで」単独は禁止）\n\n"

        "2. **行末の句読点（、。）は削除**\n"
        "   - 文中の句読点は残してよい\n\n"

        "3. **文字数は5〜17文字の範囲を厳守**\n"
        f"   - 1行の最大: {int(max_chars)}文字（全角）← 厳守\n"
        "   - 1行の最小: 5文字（全角）← 厳守\n"
        "   - 17文字を超える場合は、必ず前後の文脈を見て分割できる場所を探す\n"
        "   - 17文字超えは絶対に許容しない\n\n"

        # --- 改善3: 分割ルールを簡潔に ---
        "# 自然な分割ルール\n"
        "- 意味のまとまり（文節・フレーズ）を優先\n"
        "- 助詞での分割は許容されるが、極端に短い行にしない\n"
        "  （例: 「政策に」7文字 → OK、「に」1文字 → NG）\n"
        "- 引用表現「〜って言う/思う」は分割しない\n\n"

        # --- 改善4: 禁止事項を明確に ---
        "# 禁止事項\n"
        "- 単語の順序を変えない、結合しない\n"
        "- 要約・意訳・言い換えをしない\n"
        "- 1〜4文字の極端に短い行を作らない\n\n"

        # --- 改善5: 例を1つに統合（簡潔化） ---
        "# 良い例\n"
        "✅ 「私は大学の時の」→「12月ぐらいかなと思って」\n"
        "   理由: 意味のまとまり、5文字以上、17文字以内\n\n"

        "# 悪い例\n"
        "❌ 「私は大学の時の」→「に」（1文字）\n"
        "   理由: 極端に短い\n"
        "❌ 「何するんだって」→「言うから」\n"
        "   理由: 引用表現の分割\n\n"

        f"# Input\n"
        f"単語リスト（index:word）:\n{indexed}\n\n"

        "# Output\n"
        "以下のJSONのみを返してください（説明・コードフェンス禁止）:\n"
        '{\n'
        '  "lines": [\n'
        '    {"from": 0, "to": 10, "text": "私は大学の12月ぐらい"},\n'
        '    {"from": 11, "to": 25, "text": "政治家になろうと決めていて"}\n'
        '  ]\n'
        '}\n'
    )
```

### 変更点サマリ
| 項目 | 変更前 | 変更後 | 理由 |
|------|--------|--------|------|
| プロンプト長 | 約500行 | 約50行 | プロンプト最適化（簡潔化） |
| 最重要ルール | 中盤に記載 | 最上部に移動 | 優先度の明確化 |
| 短い行の禁止 | 「5文字以上」のみ | 「1〜4文字は絶対NG」と強調 | 改善案1対応 |
| 17文字制限 | 「少し超えても良い」 | 「17文字厳守、超過は絶対NG」 | ユーザー要求 |
| 例の数 | 10個以上 | 良い例1個、悪い例2個 | 簡潔化 |
| 句読点削除 | 複数箇所に記載 | 最上部に明記 | 改善案3対応 |

---

## 🔧 Pass3 プロンプト改善案

### 改善ポイント
1. ✅ **indexed（全単語リスト）を削除**（Phase 1）
   - Pass3では「現在の行分割」がJSONで渡されているため不要
   - プロンプト長を大幅削減（2000〜3000行 → 0行）

2. ✅ **修正ルールを5項目に簡潔化**（Phase 1）
   - 現在の8項目から3項目削除
   - 冗長な説明を削減

3. ✅ **例示を1つに削減**（Phase 1）
   - 複雑な例を削除
   - 最小限の例のみ残す

4. ✅ **検出された問題に集中**
   - validators.py で検出された問題を優先的に修正
   - 問題がない行は極力変更しない

### 改善版プロンプト

```python
def _build_pass3_prompt(self, lines: Sequence[LineRange], words: Sequence[WordTimestamp], issues) -> str:
    # --- 改善1: indexedを削除（プロンプト長を大幅削減） ---
    # indexed = _build_indexed_words(words)  # 削除

    # Format issues for LLM
    if issues:
        issue_text = "\n".join(
            [f"- {issue.description} → {issue.suggested_action}" for issue in issues]
        )
    else:
        # --- 改善2: 問題がない場合のメッセージを簡潔に ---
        issue_text = "問題は検出されませんでした。念のため全行を確認し、問題があれば最小限の修正を行ってください。"

    # Format current lines as JSON
    current_lines = json.dumps(
        [{"from": l.start_idx, "to": l.end_idx, "text": l.text} for l in lines],
        ensure_ascii=False,
        indent=2,
    )

    return (
        "# Role\n"
        "あなたはテロップの最終チェック担当の熟練編集者です。\n"
        "Pass 2で作成された字幕の行分割を確認し、問題があれば最小限の修正を行ってください。\n\n"

        "# 検出された問題\n"
        f"{issue_text}\n\n"

        # --- 改善3: 修正ルールを5項目に簡潔化（8項目→5項目） ---
        "# 修正ルール\n"
        "1. **極端に短い行（1〜4文字）**: 前行または次行と統合し、5文字以上に\n"
        "2. **17文字を超える行**: 必ず前後の文脈を見て自然な分割位置を探し、再分割\n"
        "3. **引用表現の分割「〜って言う/思う」**: 統合して1行に\n"
        "4. **修正後も制約を厳守**: 5〜17文字の範囲内（超過は絶対NG）\n"
        "5. **最小限の修正**: 問題のある行のみ修正（問題がない行は変更しない）\n"
        "6. **禁止事項**: 要約・意訳・語句の追加削除は厳禁\n\n"

        # --- 改善4: 注意事項を簡潔に ---
        "# 重要\n"
        "- 必ず1件以上の行を返してください（空配列は禁止）\n"
        "- 単語の順序を変えない\n"
        "- 問題がない行はそのまま返す（無理に変更しない）\n\n"

        "# Input\n"
        # --- indexed削除により、この部分が大幅に短縮 ---
        f"現在の行分割:\n{current_lines}\n\n"

        "# Output\n"
        "以下のJSONのみを返してください（説明・コードフェンス禁止）:\n"
        '{\n'
        '  "lines": [\n'
        '    {"from": 0, "to": 11, "text": "私は大学の時の12月ぐらいかな"},\n'
        '    {"from": 12, "to": 18, "text": "4年生の12月には"},\n'
        '    {"from": 19, "to": 28, "text": "政治家になろうという腹を決めていて"}\n'
        '  ]\n'
        '}\n'
    )
```

### 変更点サマリ
| 項目 | 変更前 | 変更後 | 理由 |
|------|--------|--------|------|
| indexed | 全単語リスト（2000〜3000行） | 削除 | プロンプト最適化（最大の削減効果） |
| 修正ルール | 8項目 | 6項目 | 簡潔化 + 17文字超過の再分割を追加 |
| 17文字制限 | 記載なし | 「超過は絶対NG、前後文脈で再分割」を明記 | ユーザー要求 |
| 例示 | 5行の複雑な例 | 3行のシンプルな例 | 簡潔化 |
| プロンプト長 | 約10,000〜20,000文字 | 約3,000〜5,000文字 | 50〜70%削減 |
| トークン数 | 5,000〜10,000トークン | 1,500〜2,500トークン | 50〜75%削減 |

---

## 🔧 Pass4 プロンプト（参考：現状維持）

Pass4は既に17文字超過の行を再分割する専用のステップなので、現状のプロンプトで問題ありません。

### 現在のプロンプト

```python
def _build_pass4_prompt(self, line: LineRange, words: Sequence[WordTimestamp]) -> str:
    indexed = "\n".join(
        f"{i}: {w.word}"
        for i, w in enumerate(words[line.start_idx : line.end_idx + 1], start=line.start_idx)
    )
    return (
        "# Role\n"
        "あなたはテロップ最終チェックの追加ステップ担当です。\n"
        "与えられた行に対してのみ、条件を満たす複数行に必要最小限で分割してください。\n\n"

        "# Constraints\n"
        "- **必ず1行あたり全角5〜17文字に収めること（厳守）**\n"
        "- 語順を変えない、語を追加/削除しない\n"
        "- 要約・翻訳・意訳をしない\n"
        "- 行末の句読点（、。）は削除。文中の句読点は残してよい\n"
        "- 改行の優先度: (1)「。?!」直後 → (2)「、」直後 → (3) 接続助詞・係助詞など自然な切れ目\n\n"

        "# Input\n"
        f"対象の行テキスト:\n{line.text}\n\n"
        f"単語リスト（index:word）:\n{indexed}\n\n"

        "# Output\n"
        "以下のJSONだけを返してください（説明・コードフェンス禁止）:\n"
        '{\n'
        '  "lines": [\n'
        '    {"from": 100, "to": 105, "text": "私は大学生です"},\n'
        '    {"from": 106, "to": 110, "text": "政治家を目指しています"}\n'
        '  ]\n'
        '}\n'
    )
```

### Pass4の役割
- Pass2/Pass3で17文字を超えた行、または5文字未満の行を検出
- それらの行のみを再分割
- 17文字厳守は既に実装されている

---

## 📊 改善効果の予測

### プロンプト長の削減（Phase 1）

| Pass | 改善前（トークン数） | 改善後（トークン数） | 削減率 |
|------|---------------------|---------------------|--------|
| Pass1 | 約1,500 | 約1,800 | +20%（固有名詞チェック追加） |
| Pass2 | 約3,000 | 約1,500 | -50%（簡潔化） |
| Pass3 | 約7,000 | 約2,000 | -70%（indexed削除） |
| **合計** | **約11,500** | **約5,300** | **-54%** |

### 処理時間の削減予測

**前提**: 12分の音声、300行の字幕

| 要素 | 改善前 | 改善後 | 削減率 |
|------|--------|--------|--------|
| Pass3プロンプト長 | 7,000トークン | 2,000トークン | -70% |
| Pass3処理時間 | 約10秒 | 約3〜4秒 | -60〜70% |
| 全体処理時間 | 約30秒 | 約18〜20秒 | -35〜40% |

**注**: 使用モデルは変更しないため、削減効果はプロンプト最適化のみによるもの

---

## 🎯 実装の優先順位

### Phase 1: プロンプト改善（即時実装）
1. ✅ Pass3のindexed削除（最も効果が大きい）
2. ✅ Pass2の簡潔化
3. ✅ Pass1に固有名詞チェック追加

### Phase 2: 検証強化（並行実装）
4. ✅ validators.py に短い行検出を追加（改善案1）
5. ✅ 句読点削除パスの追加（改善案3）

---

## 📝 次のアクション

1. このドキュメントをレビュー ✅
2. Phase 1の実装
   - two_pass.py の各Passプロンプトを更新
   - validators.py に短い行検出を追加
   - 句読点削除パスを追加
3. テスト音声で効果を検証
   - 処理時間の測定
   - 精度の確認（スコア3→4以上を目標）

---

## 🔗 関連ドキュメント

- `docs/reports/subtitle_quality_improvement_proposal_20251125.md`: 全体の改善提案
- `src/llm/two_pass.py`: 実装対象ファイル
- `src/llm/validators.py`: 検証ロジック
