# プランニングドキュメント：旧1パスLLM＋アンカー方式の撤去

**作成日**: 2025-11-23  
**バージョン**: 1.0  
**ステータス**: ドラフト  
**前バージョンからの変更**: 旧フロー（全文LLM＋[WORD:]アンカー→Fuzzyアライン）を廃止する計画を新規追加

※初めて作業に取り掛かる場合は、必ずこのプランドキュメントと別にある用件定義書にも目を通してください。

---

## ⚡ クイックリファレンス（引き継ぎ用）

> 新規エージェントが3分で状況を把握するためのサマリー

**現在地**: Phase 2 - テスト・ドキュメント整合 (92%完了)  
**次のアクション**:  
1. README/リリースノート向けに「two-pass固定・旧オプション削除」を追記  
2. 需要があれば実サンプル（非simulate）でワンショットE2Eを実行し動作確認  
3. `docs/specs/llm_two_pass_workflow.md` に今回の変更点（インデックス直マッピング）をメモ
**ブロッカー**: なし  
**重要な決定事項**: SRT生成は TwoPassFormatter 出力のみを正とし、[WORD:] アンカー＋RapidFuzzアライン経路を全面撤去する

### フェーズ進捗
- [x] Phase 0: 現状調査・仕様同期 (完了)
- [x] Phase 1: コード撤去（パイプライン/CLI/アラインメント） (100%)
- [🔄] Phase 2: テスト・依存・ドキュメント更新 (92%) ← **今ここ**
- [ ] Phase 3: リリースノート/掃除 (0%)

### 環境チェックリスト
- [x] `.venv` / `requirements.txt` インストール済み（前プロジェクトから継続）
- [ ] `CLI --help` を二段階LLM専用表記に更新
- [ ] RapidFuzz 依存を削除後に `pip check` を通す

### 重要なファイルパス
- パイプライン: `src/pipeline/poc.py`
- アライン削除対象: `src/alignment/timestamp.py`, `src/alignment/srt.py`
- LLM旧IF: `src/llm/formatter.py`
- CLIエントリ: `src/cli/main.py`
- テスト: `tests/test_alignment_timestamp.py`, `tests/test_alignment_srt.py`, `tests/test_pipeline_*`

---

## 🔄 現在の作業状態

**最終更新**: 2025-11-23 18:30 JST  
**進捗率**: 85%

### 直前の作業
- ✅ 旧1パス経路（`_format_blocks` → `align_to_srt` → RapidFuzz）を削除し TwoPass 専用化
- ✅ CLI オプション `--llm-two-pass`, `--align-*` を廃止
- ✅ RapidFuzz 依存と `src/alignment/timestamp.py` / 関連テストを削除
- ✅ 要件定義を two-pass 前提に更新（[WORD:] 記述を撤去）
- ✅ two-pass 用にテスト群を修正し、6件の関連テストを通過
- ✅ `pip check` を実行し依存破損なしを確認
- 🔄 作業中: README/共有メモ更新

### ブロッカー・未解決の問題
- [ ] 特になし

### 最近の変更履歴（直近5件）
| 日時 | 変更内容 | 関連ファイル |
|------|---------|-------------|
| 11-23 18:55 | LLMトークン使用量と処理時間のログ出力を追加（transcribe/TwoPass） | `src/pipeline/poc.py`, `src/llm/providers/*` |
| 11-23 18:50 | Runbookをtwo-pass固定/旧オプション削除に更新 | `docs/runbook.md` |
| 11-23 18:45 | LLMリクエストタイムアウトのデフォルトを500秒へ延長 (.env.exampleと設定を同期) | `src/config/settings.py`, `.env.example` |
| 11-23 18:30 | 依存確認（pip check）、two-passテスト修正・通過 | `tests/*` |
| 11-23 18:10 | TwoPass専用化、RapidFuzz/旧オプション削除、要件定義更新 | `src/pipeline/poc.py`, `src/cli/main.py`, `src/alignment/*`, `tests/*`, `requirements.txt`, `docs/requirement.md` |
| 11-23 17:00 | 旧1パスLLM撤去に関する新規PLAN作成 | `docs/plan/20251123_PLAN1.md` |

---

## 💭 主要な意思決定

- **二段階LLMのみを正系に統一**: SRT生成は TwoPassFormatter の出力に限定し、単一パス＋アンカー方式は廃止する（RapidFuzz依存も削除予定）
- **CLI簡素化**: `--llm-two-pass` フラグを撤廃し、`--align-*` オプションも併せて整理する方向で検討
- **ドキュメント同期**: 要件定義のアンカー説明・アライン手順を two-pass 基準に書き換える

---

## 📝 変更済みファイル

| ファイルパス | 状態 | 変更内容 | 影響範囲 | 関連Phase |
|-------------|------|---------|----------|-----------|
| `src/pipeline/poc.py` | 🔄 作業中 | TwoPass専用化、旧1パス経路削除 | SRT生成 | Phase 1 |
| `src/cli/main.py` | ✅ 完了 | `--llm-two-pass` / `--align-*` オプション削除 | CLI UX | Phase 1 |
| `src/alignment/timestamp.py` | ✅ 完了 | RapidFuzzベースのアライン削除 | 依存整理 | Phase 1 |
| `src/alignment/srt.py` | ✅ 完了 | SubtitleSegment整形のみへ簡素化 | 生成 | Phase 1 |
| `requirements.txt` | ✅ 完了 | rapidfuzz 依存削除 | 依存管理 | Phase 2 |
| `tests/*` | ✅ 完了 | two-pass 用のダミープロバイダーに更新 | テスト | Phase 2 |
| `docs/requirement.md` | ✅ 完了 | two-pass 前提に仕様更新 | ドキュメント | Phase 2 |

---

## 📋 目次

1. [要件概要](#要件概要)  
2. [技術選定](#技術選定)  
3. [データベース設計](#データベース設計)（不要のため削除予定）  
4. [アーキテクチャ設計](#アーキテクチャ設計)  
5. [実装フェーズ](#実装フェーズ)  
6. [リスクと対応策](#リスクと対応策)  
7. [完了条件](#完了条件)  

---

## 要件概要

### 背景・目的
TwoPassFormatter を正式フローとして固定し、旧1パスLLM＋[WORD:]アンカー＋RapidFuzzアライン経路を撤去して保守負荷と分岐を減らす。

### 実装する機能
- **旧フロー廃止**: `llm_two_pass=False` 経路と `_format_blocks` → `align_to_srt` → `align_formatted_lines` を削除
- **CLI整理**: `--llm-two-pass` / `--align-*` オプションを非推奨化し、可能なら削除
- **依存整理**: RapidFuzz 依存と関連テストを削除

### スコープ外
- TwoPassFormatter のロジック改善（閾値調整など）は今回対象外
- GUI/配布系の変更

---

## 技術選定

### 新規導入ライブラリ
- なし（削除のみ）

### 既存ライブラリの活用
- TwoPassFormatter + SubtitleSegment のみでSRT生成を完結させる

---

## データベース設計

本タスクでは該当なし。

---

## アーキテクチャ設計

### 1. ディレクトリ構造（変更点）
- `src/alignment/timestamp.py` を撤去（RapidFuzz依存のアライン機構）
- `src/alignment/srt.py` は TwoPassFormatter のセグメント整形に限定
- `src/pipeline/poc.py` の SRT生成は TwoPassFormatter 出力のみを通過

### 2. データフロー（簡略版）

```
TranscribeRunner → TwoPassFormatter → SubtitleSegment → segments_to_srt → output/*.srt
```

---

## 実装フェーズ

### Phase 0: 現状調査（0.5日想定）
- [ ] 旧フローの入口/出口を洗い出し (`poc.py`, `cli/main.py`, `alignment/*`, `llm/formatter.py`)
- [ ] 依存・テスト・ドキュメントの影響範囲リスト化

### Phase 1: コード撤去（1日）
- [ ] `llm_two_pass` フラグと `_format_blocks` 経路を削除し TwoPass 専用に統一
- [ ] `align_formatted_lines` / `align_to_srt` を参照するコードを廃止
- [ ] RapidFuzz 依存を requirements から除去

### Phase 2: テスト・ドキュメント更新（0.5日）
- [ ] `tests/test_alignment_*` など旧フロー前提のテストを削除または置換
- [ ] CLIヘルプ・README/要件定義を two-pass 基準に更新
- [ ] `pip check` 相当で依存破損がないことを確認

### Phase 3: リリースノート/掃除（0.25日）
- [ ] 変更ファイル一覧と互換性注意をまとめ、PLAN/requirement.md を同期

**合計見積もり**: 約1.75日

---

## リスクと対応策

| リスク | 内容 | 対応策 |
|-------|------|--------|
| 互換性破壊 | 旧CLIオプション利用ユーザーがエラーになる | ヘルプとエラーメッセージで two-pass 固定を明示し、ドキュメントで代替手順を記載 |
| デグレ | SRT生成ルートが1本化されることで未検出のバグが顕在化 | two-pass のスモークを追加し、既存E2Eを two-pass で通す |

---

## 完了条件

- [ ] `llm_two_pass` フラグがコード・CLIヘルプから消えている（または常時True扱いで分岐無し）
- [ ] `align_formatted_lines` 系のコード・テスト・RapidFuzz依存が削除されている
- [ ] TwoPassFormatter 経由で SRT が生成されることをE2Eで確認
- [ ] `docs/requirement.md` と 本PLAN が two-pass 前提で同期済み

---

## 🐛 トラブルシューティング・既知の問題

現時点なし。削除後に出た場合ここへ追記する。

---

## 参考リソース

- 現行 two-pass 実装: `src/llm/two_pass.py`
- 旧フロー実装: `src/alignment/timestamp.py`, `_format_blocks` (`src/pipeline/poc.py`)

---

## 開発引き継ぎ詳細

### 📌 承認内容
- [x] 旧1パスLLM＋アンカー方式を廃止する方針

### 🗂️ プロジェクト状態
- **技術スタック**: Python 3.12 / Typer CLI / TwoPassFormatter 方式へ統一予定
- **動作確認済み機能**: 現行 two-pass は既存コードで動作（要再確認）
- **既知の問題**: なし

### 🚀 実装優先順位
1. Phase 1 - コード分岐撤去（最優先）
2. Phase 2 - テスト・ドキュメント整合
3. Phase 3 - リリースノート/cleanup

### ⚠️ 重要な注意事項
- RapidFuzz 依存削除後は `pip install -e .` などの環境再構築が必要な可能性
- CLIヘルプの変更に伴い README/requirement.md の同期を必ず行う

---

## 🎯 最終ゴール

**ユーザー体験**: `python -m src.cli.main run --llm google ...` を実行すると、TwoPassFormatterのみでSRTが生成され、旧オプションなしで迷わず使える。  
**技術的ゴール**: SRT生成経路が1本化し、RapidFuzz依存が無く、テストとドキュメントが two-pass 基準で一貫している。

---

**実装準備完了！🚀**
