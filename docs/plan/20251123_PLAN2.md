# プランニングドキュメント：Pass3必須化ワークフロー

**作成日**: 2025-11-23  
**バージョン**: 1.0  
**ステータス**: ドラフト  
**前バージョンからの変更**: Pass3（検証LLM）を常に挟む設計変更タスクを新規追加

※初めて作業に取り掛かる場合は、必ずこのプランドキュメントと別にある要件定義書にも目を通してください。

---

## ⚡ クイックリファレンス（引き継ぎ用）

> 新規エージェントが3分で状況を把握するためのサマリー

**現在地**: Phase 2 - テスト & ドキュメント更新 (75%完了)  
**次のアクション**:  
1. 残テストスイート（全体）を実行し回帰を確認  
2. CLIヘルプ/RunbookへのPass3常時実行明記が必要か確認  
3. Draft PR を作成してレビュー依頼  
**ブロッカー**: なし  
**重要な決定事項**: Pass3 は常時実行。モデル設定とタイムアウトは現行（gemini-2.5-flash / settings 依存）を継続。

### フェーズ進捗
- [x] Phase 0: 課題ヒアリング (完了)
- [x] Phase 1: 設計 & 実装 (100%)
- [🔄] Phase 2: テスト & ドキュメント更新 (75%)
- [ ] Phase 3: PR整備 & リリースノート反映 (0%)

### 環境チェックリスト
- [ ] `LLM_PASS3_MODEL` / timeout が settings で既定化されているか再確認
- [ ] CLIヘルプ・docs が「Pass3常時実行」を明記（要確認）

### 重要なファイルパス
- フォーマッタ本体: `src/llm/two_pass.py`
- 検証ロジック: `src/llm/validators.py`
- 設定: `src/config/settings.py`
- テスト: `tests/test_two_pass*.py`, `tests/test_validators.py`
- 仕様: `docs/specs/llm_two_pass_workflow.md`, `docs/reports/pass3_design_proposal.md`

---

## 🔄 現在の作業状態

**最終更新**: 2025-11-23 00:00 JST  
**進捗率**: 75%

### 直前の作業
- ✅ Pass3常時実行を実装（`two_pass.run` を無条件Pass3へ変更、警告メッセージ追加）
- ✅ Pass3プロンプトを5〜17文字/改行優先度/語追加禁止など新ルールに更新（issuesなしケースにも対応）
- ✅ バリデータ閾値を「<5文字」へ引き上げ、テストを追加・修正（モックでPass3呼び出し確認）
- ✅ 仕様同期: requirement.md / llm_two_pass_workflow.md をPass3常時実行・最小長5文字に更新
- ✅ 部分テスト実行: `PYTHONPATH=. pytest -q tests/test_validators.py tests/test_two_pass_pass3.py`（6 passed）

### ブロッカー・未解決の問題
- [ ] なし

### 最近の変更履歴（直近5件）
| 日時 | 変更内容 | 関連ファイル |
|------|---------|-------------|
| 11-23 00:00 | Pass3プロンプトを5〜17文字・改行優先度付きで更新、issues無しケース文言を追加 | `src/llm/two_pass.py`, `docs/plan/20251123_PLAN2.md` |
| 11-23 00:00 | detect_issues 閾値を<5文字へ引き上げ、Pass3常時実行テストを追加 | `src/llm/validators.py`, `tests/test_two_pass_pass3.py`, `tests/test_validators.py` |
| 11-23 00:00 | 仕様同期（Pass3常時実行/最小長5文字） | `docs/requirement.md`, `docs/specs/llm_two_pass_workflow.md` |
| 11-23 00:00 | 本PLAN新規作成（Pass3必須化タスク） | `docs/plan/20251123_PLAN2.md` |

---

## 💭 主要な意思決定

- **Pass3常時実行**: detect_issues が0件でも必ず Pass3 LLM を呼び出し、問題なしなら行分割をそのまま返す。
- **モデル設定継続**: デフォルトは `gemini-2.5-flash`（settings の `pass3_model`）。タイムアウトは現行値を維持。
- **フェイルセーフ**: Pass3 が失敗/空返却の場合は Pass2 出力をフォールバックとして保持。

---

## 📝 変更済みファイル

| ファイルパス | 状態 | 変更内容 | 影響範囲 | 関連Phase |
|-------------|------|---------|----------|-----------|
| `src/llm/two_pass.py` | ✅ 完了 | Pass3を常時実行化、プロンプト更新（5〜17文字・追加禁止・改行優先度）、issues無しケース対応 | LLM最終チェック | Phase 1 |
| `src/llm/validators.py` | ✅ 完了 | 短行検出閾値を<5文字に変更 | 検証ロジック | Phase 1 |
| `tests/test_two_pass_pass3.py` | ✅ 完了 | Pass3がissues=0でも実行されることをモックで検証 | テスト | Phase 2 |
| `tests/test_validators.py` | ✅ 完了 | 短行閾値変更に合わせて期待値確認 | テスト | Phase 2 |
| `docs/requirement.md` | ✅ 完了 | Pass3常時実行・最小行長5文字を明記 | ドキュメント | Phase 2 |
| `docs/specs/llm_two_pass_workflow.md` | ✅ 完了 | Pass3常時実行/改行優先度/5〜17文字を追記 | ドキュメント | Phase 2 |

---

## 📋 目次

1. [要件概要](#要件概要)  
2. [技術選定](#技術選定)  
3. [データベース設計](#データベース設計)（不要なら削除）  
4. [アーキテクチャ設計](#アーキテクチャ設計)  
5. [実装フェーズ](#実装フェーズ)  
6. [リスクと対応策](#リスクと対応策)  
7. [完了条件](#完了条件)  

---

## 要件概要

### 背景・目的
Three-Pass ワークフローの品質検証（Pass3）が issues 無しの場合にスキップされるため、軽微な見落とし防止と挙動の一貫性確保のため常時 Pass3 を挟むようにする。

### 実装する機能
- **Pass3常時実行**: `TwoPassFormatter.run` で issues=0 でも Pass3 を呼ぶフローに変更。
- **プロンプト整備**: 「問題なし」ケースでも安全に通過する Pass3 プロンプトを設計。
- **テレメトリ**: Pass3 実行ログに issues 件数・所要時間を記録。

### スコープ外
- Pass1/2 のロジック変更
- LLMプロバイダーやモデルの追加・変更
- CLIオプションの大幅な追加・削除

### Pass3プロンプト（修正前 → 修正後案）
- 修正前のルール（現状実装）
  - 1〜4文字の極端に短い行は前後と統合
  - 「〜って言う/思う」の分割は統合
  - 17文字以内・5文字以上を維持
  - 最小限の修正（全体作り直し禁止）
  - 出力は lines JSON のみ
- 修正後のルール（既存と競合しない形で上乗せ）
  - 1. **1-4文字の極端に短い行**: 前行または次行と統合し、結合後に編集したすべての行に対して修正ルールに沿ってるか確認。
  - 要約・翻訳・意訳しない。語句の追加・削除もしない
  - 語の途中で切れている箇所は必ず連結する
  - 改行の優先度: (1)「。?!」直後 → (2)「、」直後 → (3) 接続助詞・係助詞など句が自然に切れる後ろ。名詞句/動詞句の途中は切らない。迷う場合は改行しない
  - 元の語順と文脈を保つ。句読点がない場合も上記ルール3に沿って自然に整形する

#### 修正前プロンプト全文（現行）
```
# Role
あなたはテロップの最終チェック担当の熟練編集者です。
Pass 2で作成された字幕の行分割に問題がないか確認し、必要最小限の修正を行ってください。

# 検出された問題
{issue_text}

# 修正ルール
1. **1-3文字の極端に短い行**: 前行または次行と統合
2. **引用表現の分割「〜って言う/思う」**: 統合して1行に
3. **修正後も制約を維持**: 17文字以内・4文字以上
4. **最小限の修正**: 問題箇所のみ修正（全体を作り直さない）

# Input
単語リスト（index:word）:
{indexed}

現在の行分割:
{current_lines}

# Output
修正後の行分割（JSONのみ）:
{"lines":[{"from":0,"to":10,"text":"..."}]}
```

#### 修正後プロンプト案（追加ルール反映・最小長5文字に統一）
```
# Role
あなたはテロップの最終チェック担当の熟練編集者です。
Pass 2で作成された字幕の行分割に問題がないか確認し、必要最小限の修正を行ってください。

# 検出された問題
{issue_text}

# 修正ルール
1. **1-4文字の極端に短い行**: 前行または次行と統合し、結合後に編集したすべての行が修正ルールに沿っているか確認
2. **引用表現の分割「〜って言う/思う」**: 統合して1行に
3. **修正後も制約を維持**: 17文字以内・5文字以上
4. **最小限の修正**: 問題箇所のみ修正（全体を作り直さない）
5. **要約・翻訳・意訳をしない**。語句の追加・削除もしない
6. **語の途中で切れている箇所は必ず連結**（分断された語を統合）
7. **改行の優先度**: (1)「。?!」直後 → (2)「、」直後 → (3) 接続助詞・係助詞など句が自然に切れる後ろ。名詞句/動詞句の途中は切らない。迷う場合は改行しない
8. **元の語順と文脈を保つ**。句読点がない場合も上記7に沿って自然に整形する

# Input
単語リスト（index:word）:
{indexed}

現在の行分割:
{current_lines}

# Output
修正後の行分割（JSONのみ）:
{"lines":[{"from":0,"to":10,"text":"..."}]}
```

---

## 技術選定

### 新規導入ライブラリ
- なし（既存LLMクライアントを流用）

### 既存ライブラリの活用
- `TwoPassFormatter` / `validators.detect_issues` を拡張し、Pass3 を必須ステップとして実行

---

## データベース設計

本タスクでは該当なし。

---

## アーキテクチャ設計

### 1. ディレクトリ構造（影響範囲）
```
src/llm/two_pass.py        # Pass1/2/3制御の中心
src/llm/validators.py      # issues検出ロジック（呼び出し位置変更のみ想定）
tests/test_two_pass*.py    # Pass3呼び出しを検証するテスト追加
```

### 2. データフロー（変更点）
```
Pass1 (clean) → Pass2 (split) → Pass3 (always validate/correct) → segments_to_srt
```

---

## 実装フェーズ

### Phase 0: 仕様確認（0.25日）
- [ ] two_pass.run の現行分岐を確認し、Pass3未実行パスを洗い出す
- [ ] Pass3プロンプトの「問題なし」入力パターンを定義

### Phase 1: 実装（0.5日）
- [ ] `enable_pass3` フラグを常時 True 相当のフローに変更（必要なら引数は非推奨扱いにメモ）
- [ ] issues=0 でも Pass3 を呼ぶよう run を改修（フォールバックは Pass2 出力）
- [ ] Pass3 プロンプトを「5文字以上・17文字以内」基準に更新し、issues が空の場合のテンプレートも追加
- [ ] ログに Pass3 実行時間・件数を出力

### Phase 2: テスト & ドキュメント（0.5日）
- [ ] テスト追加: detect_issues が空でも Pass3 呼び出しが行われることを検証（モックで call 回数確認）
- [ ] 既存テスト修正: 短行基準を「<5文字」に変更しアサート更新
- [ ] `docs/requirement.md` / `docs/specs/llm_two_pass_workflow.md` を「Pass3常時実行」に同期

### Phase 3: PR整備（0.25日）
- [ ] 変更概要・互換性影響（トークンコスト増）を記載し Draft PR 更新
- [ ] リリースノート/Runbook 追記（Pass3必須化）

**合計見積もり**: 約1.5日

---

## リスクと対応策

| リスク | 内容 | 対応策 |
|-------|------|--------|
| トークンコスト増加 | Pass3を毎回呼ぶことでAPIコストが増える | Pass3モデルを低コストデフォルト維持、必要なら設定値で切替案内 |
| レイテンシ増加 | 追加呼び出しで処理時間が伸びる | ログで計測し、並列化やtimeout調整を検討 |
| Pass3失敗時の空返却 | LLM失敗で行分割が空になる | Pass2結果へフォールバックするガードを残す |

---

## 完了条件

- [ ] `TwoPassFormatter.run` が issues=0 でも Pass3 を実行し、結果が空なら Pass2 を用いる
- [ ] Pass3 プロンプトが「問題なし」入力でも安定して JSON を返す
- [ ] テストで Pass3 呼び出しが保証される（モック/計測で確認）
- [ ] `docs/requirement.md` / 仕様ドキュメントが「Pass3常時実行」に更新済み

---

## 🐛 トラブルシューティング・既知の問題

現時点なし。発生時に追記。

---

## 参考リソース

- `docs/specs/llm_two_pass_workflow.md`
- `docs/reports/pass3_design_proposal.md`
- `src/llm/two_pass.py`, `src/llm/validators.py`

---

## 開発引き継ぎ詳細

### 📌 承認内容
- [x] Pass3 を常時実行する方針

### 🗂️ プロジェクト状態
- **技術スタック**: Python 3.12 / Typer CLI / LLM三段階ワークフロー
- **動作確認済み機能**: Pass1/Pass2 動作（既存実装）。Pass3は従来 issues ありの場合のみ実行。
- **既知の問題**: なし

### 🚀 実装優先順位
1. Phase 1 - 実装
2. Phase 2 - テスト & ドキュメント
3. Phase 3 - PR整備

### ⚠️ 重要な注意事項

- Pass3呼び出しでトークンコストが増えるため、モデル設定を再確認してから運用すること。
- フォールバックで Pass2 結果を保持し、LLM障害時の安全性を担保する。

---

## 🎯 最終ゴール

**ユーザー体験**: CLI 実行時に必ず品質検証（Pass3）が走り、短行や引用分割が残らない字幕が得られる。  
**技術的ゴール**: Pass3 が常時実行され、失敗時は Pass2 へフォールバックしつつログで可視化される。

---

**実装準備完了！🚀**
