# プランニングドキュメント：テロップ処理改善＆SRTギャップ埋め

**作成日**: 2025-11-27  
**バージョン**: 1.0  
**ステータス**: ドラフト  
**前バージョンからの変更**: 初版作成（docs/処理改善案.md に基づき、SRTギャップ埋め仕様を追加）

※初めて作業に取り掛かる場合は、必ずこのプランドキュメントと別にある要件定義書（`docs/requirement.md`）にも目を通してください。

---

# 進捗状況

## ⚡ クイックリファレンス

> 新規エージェントが3分で状況を把握するためのサマリー

**現在地**: Phase 1 修正中（テロップ表示タイミング問題対応）  
**次のアクション**: テロップが発話より早く表示される問題の解決  
**ブロッカー**: Whisperのタイムスタンプが実際の発話より早いケースがある  
**重要な決定事項**:

- SRT上のテロップは「空白時間なし」で連続表示させる（WordTimestamp 自体は変えず、SRTセグメントの end 時刻のみ延長する）
- 次のセグメント開始時刻は絶対に変更しない（Whisperの検出タイミングを優先）

### フェーズ進捗

- [x] Phase 0: 現状把握（docs/requirement.md・docs/処理改善案.md・two_pass.py・srt.py の読み込み）  
- [🔄] Phase 1: SRTギャップ埋め仕様の設計＆実装（**修正中** - テロップ表示タイミング問題対応） ← **現在ここ**  
  - ✅ 基本実装完了（2025-11-28）
  - ✅ gap_padding パラメータ追加（2025-12-10）
  - ✅ 次セグメント開始時刻の優先ロジック実装（2025-12-10）
- [x] Phase 1.5: GUIログ保存機能（100%完了 - 2025-12-10）
- [ ] Phase 2: 行分割精度の改善（Pass2/Pass3 プロンプト調整＋テスト追加）  
- [ ] Phase 3: Pass4 のバッチ化による処理時間最適化  
- [ ] Phase 4: 形態素解析導入の調査・設計（Sudachi等の候補検討）

### 環境チェックリスト

- [ ] `.env` に LLM 関連キー（`GOOGLE_API_KEY` / `OPENAI_API_KEY` / `ANTHROPIC_API_KEY`）が設定されている  
- [ ] `LLM_PASS1_MODEL`〜`LLM_PASS4_MODEL` のデフォルト値を確認（現行運用とズレがないか）  
- [ ] Python 仮想環境（venv）が有効になっている（`python -m venv .venv` → 有効化）  

※上記は本タスクの実装前に確認しておくこと。未確認の場合は「未設定」「要確認」として更新する。

### 重要なファイルパス

- メインCLI: `src/cli/main.py`  
- テロップ行分割ロジック: `src/llm/two_pass.py`（`TwoPassFormatter` / `_ranges_to_segments`）  
- SRT出力ユーティリティ: `src/alignment/srt.py`（`SubtitleSegment` / `segments_to_srt`）  
- 検証ロジック: `src/llm/validators.py`  
- 要件定義: `docs/requirement.md`  
- テロップ処理改善メモ: `docs/処理改善案.md`  

---

## 🔄 現在の作業状態

**最終更新**: 2025-12-13 21:13 JST  
**進捗率**: 30%（Phase 1 start_delay機能完了 + Phase 1.5 完了）

### 直前の作業

- ✅ 完了: Phase 1 SRTギャップ埋め実装（2025-11-28）
  - `TwoPassFormatter` に `fill_gaps` パラメータ（ON/OFFフラグ）を追加
  - `TwoPassFormatter` に `max_gap_duration` パラメータ（閾値）を追加
  - `_fill_segment_gaps` メソッドを閾値対応に更新
  - テストケース 9件追加（`tests/test_fill_segment_gaps.py`）
  - 全テスト 52件パス確認済み
- ✅ 完了: Phase 1 ギャップ埋めロジック強化（2025-12-10）
  - `gap_padding` パラメータ追加（デフォルト: 0.15秒）
  - 次セグメント開始時刻を優先するロジックに変更（Whisperのタイミングを尊重）
  - テストケース更新（`test_padding_respects_next_start`, `test_padding_with_max_gap_limit`）
- ✅ 完了: GUIログ保存機能（2025-12-10）
  - 処理完了時に `logs/llm_raw`, `temp/poc_samples`, `temp/progress` を出力先にコピー
  - 出力形式: `{audio_name}_{model}_{timestamp}_logs/`
- ✅ 完了: start_delay機能の実装（2025-12-13）
  - テロップ開始時間を一律で遅らせるオプションを追加
  - CLI: `--start-delay 0.2` / GUI: 「開始遅延(秒)」入力フィールド
  - 最初のテロップのstartと最後のendは維持、ギャップは自動で埋める
  - テスト: 8件追加（`tests/test_start_delay.py`）
- ⏳ 次のタスク: Phase 2 行分割精度の改善へ

### ブロッカー・未解決の問題

- [x] 「会話の無音区間」の扱い → `max_gap_duration` パラメータで制御可能にした
- [x] SRTビューア側の挙動 → 標準的な end 延長方式で実装したため、主要プレイヤーで問題ない想定
- [x] **テロップが発話より早く表示される問題** → `--start-delay` オプションで解決
  - 現象: 一部のテロップが、実際の音声が始まる前に表示されてしまう
  - 原因: Whisperのタイムスタンプが実際の発話より早いケースがある
  - 対策: `--start-delay 0.2` のようにテロップ開始を遅らせることで調整可能

### 最近の変更履歴（直近5件）

| 日時 | 変更内容 | 関連ファイル |
|------|---------|-------------|
| 12-13 21:10 | start_delay機能実装（CLI/GUIでテロップ開始時間を遅らせる） | `src/llm/two_pass.py`, `src/cli/main.py`, `src/gui/workflow_panel.py`, `src/gui/controller.py` |
| 12-10 19:00 | GUIログ保存機能実装（llm_raw, poc_samples, progress を出力先にコピー） | `src/gui/controller.py`, `src/gui/workflow_panel.py` |
| 12-10 16:00 | gap_padding パラメータ追加＆次セグメント開始優先ロジック実装 | `src/llm/two_pass.py`, `tests/test_fill_segment_gaps.py` |
| 12-10 16:00 | Macパッケージングドキュメント作成＆tkinter問題修正 | `docs/packaging.md`, `FlowCut.spec` |
| 11-28 14:00 | Phase 1 完了: SRTギャップ埋め実装（fill_gaps/max_gap_durationパラメータ追加） | `src/llm/two_pass.py`, `tests/test_fill_segment_gaps.py` |

---

## 開発引き継ぎ詳細

### 📌 承認内容

- [x] docs/処理改善案.md に書かれている「テロップ行分割精度」の課題は中長期テーマとし、まずは「SRTギャップ埋め＋既存TwoPassの仕様との整合性」を優先する  
- [x] SRTの空白時間はすべて「直前のテロップを表示し続ける」仕様にする（無音区間も含めて字幕が途切れない状態を目指す）  

### 🗂️ プロジェクト状態

- **技術スタック**: Python 3.10–3.12, MLX Whisper large-v3, OpenAI Whisper large-v3, 各種 LLM API（Google / OpenAI / Anthropic）  
- **動作確認済み機能**: 文字起こし（Whisper系）、TwoPassFormatter によるテロップ行分割、SRT 出力までの一連フロー（※詳細は既存テスト＆サンプルに依存）  
- **既知の問題**:  
  - 行の区切りが不自然なケースが残っている（docs/処理改善案.md 3章）  
  - 固有名詞（人名・組織名など）の漢字誤りが残るケースがある  
  - Pass3/Pass4 の処理時間が長くなりがち（ただし精度優先の方針）

### 🚀 実装優先順位

1. **Phase 1** - SRTギャップ埋め（視覚的な「テロップが途切れない」体験の実現）  
2. **Phase 2** - 行分割精度の改善（ユーザーが気になる不自然な切れ方を減らす）  
3. **Phase 3** - Pass4 バッチ化＆処理時間短縮（精度を維持したままの高速化）  
4. **Phase 4** - 形態素解析の導入検討（ルールベース補助でLLM負荷を軽減）  

### ⚠️ 重要な注意事項

- **タイムコード整合性**: WordTimestamp（元の単語ごとの start/end）は変更しない。SRT上での表示時間延長のみでギャップを埋める  
- **精度優先**: 行分割や固有名詞修正に関しては、処理時間よりも「自然さ」「正しい表記」を優先する方針を維持する  
- **ロールバック容易性**: ギャップ埋め処理は専用関数に切り出し、問題発生時に簡単に無効化/ロールバックできる設計にする  

---

# 実装内容

## 💭 主要な意思決定

> 実装方針の一貫性を保つための判断履歴

- **SRTギャップ埋めをTwoPassFormatter側で実施**: WordTimestampに手を入れず、`TwoPassFormatter._ranges_to_segments` もしくはその直後で SRT セグメントを後処理する方針  
- **テロップの連続表示を優先**: 無音区間を含めて画面上のテロップが途切れないことを重視（ただし、極端に長い無音をどう扱うかは閾値で制御可能にする）  
- **既存プロンプトの大枠は維持**: Pass1〜4 のプロンプト構造は一旦維持し、まずはギャップ埋め＋テスト強化から着手する  

---

## 📋 目次

1. [要件概要](#要件概要)  
2. [技術選定](#技術選定)  
3. [データベース設計](#データベース設計)（なし）  
4. [アーキテクチャ設計](#アーキテクチャ設計)  
5. [実装フェーズ](#実装フェーズ)  
6. [リスクと対応策](#リスクと対応策)  
7. [完了条件](#完了条件)  
8. [トラブルシューティング・既知の問題](#-トラブルシューティング既知の問題)  

---

## 要件概要

### 背景・目的

現状の FlowCut では、テロップ行分割自体は TwoPassFormatter により実現できているものの、  
出力された SRT を動画に載せた際に「テロップが一瞬消える空白時間」が存在する。  
ユーザーとしては、編集時・視聴時ともに「常に何かしらのテロップが表示されている」状態の方が扱いやすいため、  
SRT上の空白時間を埋めてテロップ表示を連続させることが今回の主目的。

### 実装する機能

- **SRTギャップ埋め機能**: 連続するテロップの間に存在する空白時間を検出し、前のテロップの end 時刻を次のテロップの start まで延長する  
- **ギャップ検出ロジックの実装**: 「どこまでを空白とみなすか」を定義し（例: 0.0秒以上のギャップは埋める / 5秒以上は例外など）、柔軟に調整できるようにする  
- **将来のテロップ精度改善の土台**: docs/処理改善案.md に列挙されている課題（行分割精度・固有名詞・処理時間）を Phase 2 以降で解決しやすいよう、責務分離とテスト整備を進める  

### スコープ外

- テキスト内容そのものの大規模なリライト（要約・言い換え・翻訳など）  
- 形態素解析器の具体的実装（Sudachi 導入など）は Phase 4 以降の検討とし、本PLANでは設計レベルの整理のみ  
- 新しいGUI（FlowCut GUI）の画面設計やUI変更（今回はあくまでテロップ処理ロジックのみ対象）  

---

## 技術選定

### 新規導入ライブラリ

本タスクでは **新規ライブラリの導入は行わない想定**。  
（形態素解析ライブラリを入れる場合は、別フェーズで Sudachi 等を比較検討し、その時点で context7 MCP で仕様確認する）

### 既存ライブラリの活用

- `src/llm/two_pass.py`: TwoPassFormatter によるテロップ行分割と LLM 呼び出しロジック  
- `src/alignment/srt.py`: `SubtitleSegment` / `segments_to_srt` による SRT出力  
- `src/llm/validators.py`: 行分割の検証ロジック（極端に短い行や不自然な分割の検出）  

---

## データベース設計

本プロジェクトはファイルベース処理であり、DB変更は想定していないため、このセクションは対象外。

---

## アーキテクチャ設計

### 1. ディレクトリ構造（本タスクに関係する部分）

```
project-root/
├── src/
│   ├── cli/
│   │   └── main.py            # CLIエントリポイント
│   ├── llm/
│   │   ├── two_pass.py        # TwoPassFormatter（テロップ行分割の中心）
│   │   └── validators.py      # 行分割の検証ロジック
│   └── alignment/
│       └── srt.py             # SubtitleSegment / segments_to_srt
└── docs/
    ├── requirement.md         # 要件定義
    ├── 処理改善案.md          # テロップ処理改善メモ
    └── plan/20251127_PLAN1.md # 本PLAN
```

### 2. データフロー

```
Whisper 文字起こし (WordTimestamp一覧)
        ↓
TwoPassFormatter.run()
  - Pass1: 誤認識修正（replace/delete）
  - Pass2: 行分割 (LineRange配列)
  - Pass3: 検証＆最小修正
  - Pass4: 長さ違反行の再分割
        ↓
_ranges_to_segments()
  - LineRange + WordTimestamp から SubtitleSegment リスト生成
  - ★ 新規: セグメント間ギャップの検出＆前行の end 延長で埋める
        ↓
segments_to_srt()
  - SubtitleSegment リストから最終 SRT テキストを生成
```

### 3. 主要コンポーネント

- **`TwoPassFormatter`（`src/llm/two_pass.py`）**: LLMを用いた二段階整形＆行分割の中心クラス  
- **`SubtitleSegment` / `segments_to_srt`（`src/alignment/srt.py`）**: SRTフォーマットへの変換ユーティリティ  
- **`validators`（`src/llm/validators.py`）**: 行分割結果の品質チェックを行うモジュール  

---

## 実装フェーズ

### Phase 0: 事前準備（完了）

- [x] 要件定義（`docs/requirement.md`）と処理改善メモ（`docs/処理改善案.md`）の読込み  
- [x] `TwoPassFormatter.run()` と `_ranges_to_segments` の現状仕様の確認  
- [x] `SubtitleSegment` / `segments_to_srt` の挙動確認  

### Phase 1: SRTギャップ埋め（1〜2日想定） 🔄 **修正中**

- [x] 「ギャップ」の定義を決める → デフォルトですべての正のギャップを埋める、`max_gap_duration` で閾値制御可能  
- [x] ギャップ埋め処理の実装箇所を決定 → `TwoPassFormatter._fill_segment_gaps` メソッド  
- [x] ギャップ検出＆前end延長アルゴリズムを実装
  - `fill_gaps: bool = True` パラメータでON/OFF切替  
  - `max_gap_duration: float | None = None` パラメータで閾値制御（None=上限なし）  
  - `gap_padding: float = 0.15` パラメータで余韻時間調整
- [x] テストケース作成 → `tests/test_fill_segment_gaps.py` に 10 件のテスト追加  
- [ ] **未解決: テロップが発話より早く表示される問題**

#### 現在のギャップ埋め実装の仕組み

```python
# TwoPassFormatter._fill_segment_gaps のロジック概要

for i in range(len(segments) - 1):
    current = segments[i]
    nxt = segments[i + 1]
    
    gap = nxt.start - current.end  # ギャップ計算
    
    if gap > 0:
        # ギャップがある場合 → 前のテロップの end を次の start まで延長
        # （max_gap_duration を超える場合は gap_padding 分だけ延長）
        current.end = nxt.start
    
    # 次のセグメントの start は変更しない（Whisperのタイミングを優先）
```

**問題点**: Whisperが返す `start` が実際の発話より早い場合があり、そのまま使うとテロップがフライング表示される。

**実装のポイント**:

- **次セグメント開始時刻は絶対に変更しない**（Whisperの検出タイミングを優先し、フライング表示を防ぐ）

### Phase 1.5: GUIログ保存機能 ✅ **完了**

- [x] 処理完了時にログディレクトリを自動コピー
  - `logs/llm_raw/` → LLM API の生リクエスト/レスポンス
  - `temp/poc_samples/` → 中間処理結果
  - `temp/progress/` → 進捗JSON
- [x] 出力先: `{subtitle_dir}/{audio_basename}_{model}_{timestamp}_logs/`
- [x] GUI完了メッセージにログフォルダ名を表示  

### Phase 2: 行分割精度改善（2〜3日想定）

- [ ] docs/処理改善案.md 3章の「行の区切りの不自然さ」の事例をテストケース化  
- [ ] Pass2 プロンプトのルール整理と改善（良い例・悪い例をプロンプトに追加）  
- [ ] Pass3 の役割を「最小修正チェッカー」として明確化し、issues 0件時の挙動を整理  
- [ ] 固有名詞誤りが起こりやすいパターンを洗い出し、Pass1 プロンプトでのガードを強化  

### Phase 3: Pass4 バッチ化（2〜3日想定）

- [ ] 既存の Pass4 挙動（1行ごとにLLM呼び出し）の実測時間を測定  
- [ ] バッチ化のインターフェース設計（`line_id` 付きJSON構造など）  
- [ ] Python 側のパーサ実装と、既存ロジックとの互換性確認  
- [ ] コスト・速度・精度のトレードオフを比較（小さめの検証データセットを用意）

### Phase 4: 形態素解析導入検討（設計のみ／実装は別PLAN）

- [ ] 形態素解析器（Sudachi等）の候補調査（ライセンス・性能・導入難度）  
- [ ] 行分割ルールと形態素情報の連携案を整理（「ここは切らない」などのルール化）  
- [ ] LLMプロンプトに渡すメタ情報のフォーマット案を作成  

### Phase N: 統合テスト・ドキュメント更新

- [ ] CLI 全体フローでの統合テスト（`python -m src.cli.main run ... --llm ...`）  
- [ ] docs/requirement.md に最終仕様を反映（SRTギャップ埋め仕様／行分割ポリシーなど）  
- [ ] このPLANと runbook（`docs/runbook.md`）の更新  

---

## リスクと対応策

- **リスク**: ギャップ埋めにより、実際には話していない時間にもテロップが表示されるため、誤解を生む可能性  
  - **対応**: 無音が極端に長い場合はギャップ埋めを行わないなど、閾値付きで制御できるようにする  
- **リスク**: 既存ユーザーが「ギャップあり」の挙動に慣れている場合、挙動変更が戸惑いを生む  
  - **対応**: 設定フラグ（例: `--fill-gaps/--no-fill-gaps`）でオンオフ切替できる余地を残す（最初はデフォルトON想定）  
- **リスク**: 行分割ロジックへの影響で、SRTの表示順や時間が崩れる  
  - **対応**: ギャップ埋めは「セグメントリスト生成の最後に行うポストプロセス」とし、元のアルゴリズムを壊さない  

---

## 完了条件

### 機能要件

- [ ] SRTファイルを動画プレイヤーに読み込んだ際、基本的にテロップが途切れず表示される  
- [ ] ギャップ埋め処理のON/OFFまたは閾値が設定/変更できる（少なくともコード上で簡単に調整可能）  
- [ ] 既存のテストケース／サンプルに対して、行分割の品質が劣化していない  

### 品質要件

- [ ] WordTimestamp の整合性（順序・start/end の関係）が壊れていない  
- [ ] Typeチェック・ビルドが通る（`npm run type-check` 等、プロジェクト標準コマンドに従う）  
- [ ] 主要なサンプル音声での確認時に、SRTの表示が自然である  

### ドキュメント

- [ ] `docs/requirement.md` に SRTギャップ埋め仕様を追記  
- [ ] `docs/処理改善案.md` に「ギャップ埋め対応済み」としてメモを更新  
- [ ] 本PLAN（`docs/plan/20251127_PLAN1.md`）の進捗・決定事項を最終状態に更新  

---

## 🐛 トラブルシューティング・既知の問題

### 遭遇しうる問題と対応方針（仮）

#### 注意ポイント1: テロップが「伸びすぎて」違和感が出る

**問題**: 無音区間が長い場合、前のテロップが長時間表示され続けてしまい、かえって不自然になる  
**対応**: ギャップの最大長を設定し、それを超える場合は埋めない or 別のテロップ（例: 無音を示す短い行）を挿入する余地を残す  
**影響ファイル**: `src/llm/two_pass.py`（ギャップ埋めロジック）  

---

## 参考リソース

### 公式ドキュメント

- Whisper / MLX Whisper: 既存導入済み（詳細は開発時に公式ドキュメントを参照）  
- 各LLMプロバイダー（OpenAI / Google / Anthropic）のAPI仕様: 実装時は context7 MCP 経由で最新仕様を確認すること  
- <https://note.com/sepapalab/n/nbfee583651e9→ginzaというライブラリで日本語改行している事例>

### 関連プランドキュメント

- 現時点では本PLANのみ。今後、別機能用のPLANが増えた場合はここに追記する。  

---

**実装準備完了！🚀（このPLANに沿って、次は Phase 1 の実装方針を詳細化 → ブランチ作成＆Draft PR 作成へ進む）**
