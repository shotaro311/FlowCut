# プランニングドキュメント：GUIアプリ（Flow Cut フロントエンド）

**作成日**: 2025-11-25  
**バージョン**: 1.1  
**ステータス**: 実装中（Phase 1 完了）  
**前バージョンからの変更**: Tkinter最小GUIの実装完了、SRT保存先選択機能・CLI `--subtitle-dir` 追加、python.org版3.12 + Tkinter前提を明文化

※このプランは、既存の CLI パイプライン（`src/pipeline/poc.py`）をそのまま流用しながら、GUIと将来のWeb UIを安全に増やしていくための設計・実装方針をまとめたものです。

---

## ⚡ クイックリファレンス（引き継ぎ用）

> 新規エージェントが3分で状況を把握するためのサマリー

**現在地**: Phase 1 - `src/gui/app.py` / `src/gui/controller.py` で最小GUI（ファイル選択＋保存先選択＋実行）が完成（約40%完了）  
**次のアクション**: Phase 2 として「工程別ステータス表示（音声解析中 / AI思考中 / ファイル生成中）」をGUIに反映する設計と実装を進める。  
**ブロッカー**: なし（GUI実行には python.org 版 Python 3.12 + Tkinter が必要だが、開発環境では解消済み）  
**重要な決定事項**: コアロジックは `execute_poc_run` に集約し、GUI/CLI/Web いずれもこの関数を通して実行する（UIごとにロジックを複製しない）。

### フェーズ進捗
- [x] Phase 0: 設計・PLAN作成・環境方針整理 完了  
- [x] Phase 1: 最小GUI（ファイル選択＋実行ボタン＋保存先選択）（CLI `--subtitle-dir` 追加含む）  
- [ ] Phase 2: ステータス詳細化（工程別の進捗表示）  
- [ ] Phase 3: オプションUI（LLM選択、リライトON/OFF、高精度モード）  
- [ ] Phase 4: Web UI検討（API化＋ブラウザフロント）  

### 環境チェックリスト
- [x] python.org 版 Python 3.12 インストール済み（Tkinter同梱）  
- [x] `.venv-gui` など Tkinter対応Pythonで作った仮想環境がある  
- [x] `requirements-dev.txt` 導入済み  
- [ ] 友人配布用の `.app` パッケージングは未実施（Phase 4以降で検討）  

### 重要なファイルパス
- メインCLI: `src/cli/main.py`  
- パイプライン本体: `src/pipeline/poc.py`  
- GUIウィンドウ: `src/gui/app.py`  
- GUI用コントローラ: `src/gui/controller.py`  
- 要件定義: `docs/requirement.md`  
- 本PLAN: `docs/plan/20251125_PLAN1.md`

---

## 🔄 現在の作業状態

**最終更新**: 2025-11-25 22:00 JST  
**進捗率**: 約40%

### 直前の作業
- ✅ 完了: `src/gui/app.py` に最小GUI（ファイル選択・保存先フォルダ選択・実行ボタン・ステータス表示・簡易プログレスバー）を実装  
- ✅ 完了: `src/gui/controller.py` で `execute_poc_run` をバックグラウンドスレッドから呼び出す `GuiController` を実装  
- ✅ 完了: CLI `run` コマンドに `--subtitle-dir` を追加し、SRT保存先ディレクトリを指定できるようにした  
- ✅ 完了: `docs/requirement.md` / `docs/runbook.md` にGUI/CLIの出力仕様を反映  
- 🔄 作業中: Phase 2（工程別ステータス表示）の要件・UI設計（まだコードには着手していない）  
- ⏳ 次のタスク:  
  - LLMステータス（例: 「AI思考中…」）と音声解析の進捗をGUIにどうマッピングするかを整理  
  - 進捗を細かく見せるか、シンプルなメッセージにとどめるかを決める  

### ブロッカー・未解決の問題
- [ ] GUI と CLI の両方から長尺音声を実行したときの UX（時間がかかる間の見え方）をまだ十分検証できていない  
- [ ] `.app` 化したときに Gatekeeper まわりで発生しうる問題（未検証・TODO）  

### 最近の変更履歴（直近5件）
| 日時 | 変更内容 | 関連ファイル |
|------|---------|-------------|
| 11-25 21:50 | GUI最小実装＋保存先選択＋CLI `--subtitle-dir` 追加 | `src/gui/app.py`, `src/gui/controller.py`, `src/cli/main.py`, `docs/requirement.md` |
| 11-25 21:00 | Codexによる Tkinter GUI エントリポイント初回実装を `feat/gui-tkinter` にマージ | 上記 + `src/gui/README.md` |
| 11-25 20:30 | GUI向けPLAN（簡易版）作成 → 本テンプレート版に差し替え | `docs/plan/20251125_PLAN1.md` |

---

## 💭 主要な意思決定

- **Tkinter + ttk 採用**: 追加ライブラリ不要で macOS 上でもすぐ動き、Python標準だけで最小GUIを構築できるため（代替案: Flet / Tauri+React は将来のリッチUI用に温存）。  
- **コアロジック再利用**: 文字起こし〜LLM整形〜SRT出力は `execute_poc_run` に集約し、GUI側ではパラメータを集めて渡すだけにすることで、CLI/GUI/Web の挙動差を最小化。  
- **SRT保存先はユーザー選択可能**: デフォルトは `output/` だが、GUI上から任意ディレクトリを選べるようにして、友人がプロジェクトごとに保存場所を分けやすくする。CLIでも `--subtitle-dir` で同じことができる。  
- **実行は本番モード（simulate=False）**: GUIからの実行はデフォルトで実際のモデル・LLMを使う前提とし、「お試し用のシミュレーション」は必要になったら別オプションで検討する。  
- **python.org 版 Python 3.12 前提**: Tkinter を安定して使うため、Homebrew版ではなく python.org 版3.12 + venv でGUIを動かす方針とする。  

---

## 📝 変更済みファイル

| ファイルパス | 状態 | 変更内容 | 影響範囲 | 関連Phase |
|-------------|------|---------|----------|-----------|
| `src/cli/main.py` | ✅ 完了 | `gui` サブコマンド追加、`--subtitle-dir` オプション追加、Tkinterエラー時のガード実装 | CLI全体 / GUI起動方法 | Phase 1 |
| `src/gui/app.py` | ✅ 完了 | Tkinterメインウィンドウ（ファイル選択・保存先選択・実行ボタン・進捗バー・ステータス表示）の実装 | GUI UXの土台 | Phase 1 |
| `src/gui/controller.py` | ✅ 完了 | `GuiController` によるバックグラウンド実行とSRT出力パス収集 | GUI⇔パイプライン連携 | Phase 1 |
| `src/gui/README.md` | ✅ 完了 | GUIモジュールの責務と起動方法の説明 | 開発者向けドキュメント | Phase 1 |
| `docs/requirement.md` | ✅ 完了 | GUI仕様（保存先選択・CLIとの整合）と `--subtitle-dir` オプションを反映 | 要件定義 | Phase 1 |
| `docs/runbook.md` | ✅ 完了 | 主要オプション表に `--subtitle-dir` を追加 | 開発者向けRunbook | Phase 1 |
| `docs/plan/20251125_PLAN1.md` | 🔄 作業中 | 本テンプレートに沿ったPLANとして再構成 | 設計・引き継ぎ用 | Phase 0 |

---

## 📋 目次

1. [要件概要](#要件概要)  
2. [技術選定](#技術選定)  
3. [アーキテクチャ設計](#アーキテクチャ設計)  
4. [実装フェーズ](#実装フェーズ)  
5. [リスクと対応策](#リスクと対応策)  
6. [完了条件](#完了条件)  
7. [🐛 トラブルシューティング・既知の問題](#-トラブルシューティング既知の問題)  
8. [参考リソース](#参考リソース)  
9. [開発引き継ぎ詳細](#開発引き継ぎ詳細)  
10. [最終ゴール](#-最終ゴール)  

---

## 要件概要

### 背景・目的
CLI からの利用は整っているものの、非エンジニアの友人にとって「ターミナル操作」は心理的ハードルが高い。  
このフェーズでは、**PythonをインストールしてGUIを起動するだけで、音声→SRT生成まで完結できるデスクトップアプリ**を用意する。  
将来的には Web UI（ブラウザ）版も視野に入れつつ、まずはデスクトップ版で体験を固める。

### 実装する機能
- **[GUI起動]**: `python -m src.cli.main gui` で Tkinterウィンドウを起動。  
- **[ファイル入力]**: ファイル選択ダイアログから音声ファイルを指定。  
- **[保存先選択]**: デフォルト `output/` だが、GUI上の「保存先を変更」ボタンから任意フォルダを選択可能。  
- **[実行ボタン]**: `execute_poc_run` をバックグラウンドで実行し、SRTを生成。  
- **[ステータス表示]**: 「待機中」「処理中…」「完了しました」「エラーが発生しました」をGUI上で表示。  

### スコープ外
- GUIでの詳細ログ閲覧、実行履歴管理、複数ファイル一括処理などの高度な機能。  
- Webフロントエンド（ブラウザ上の画面）の実装（フェーズ4以降で検討）。  
- `.app` パッケージングと配布フローの詳細（別PLANまたは別セクションで扱う）。  

---

## 技術選定

### 新規導入ライブラリ

現時点では **Tkinter（標準ライブラリ）＋ ttk** のみを使用し、外部GUIライブラリは導入しない。

| ライブラリ | バージョン | 選定理由 |
|-----------|-----------|---------|
| `tkinter` / `ttk` | Python標準（3.12系） | 追加インストール不要、macOSでTkinter同梱の公式Pythonが入っていれば動作するため |

### 既存ライブラリの活用
- `src/pipeline/poc.py` の `execute_poc_run`: GUI/CLI/Webすべてから共通利用する中核。  
- `src/config/settings.py`: LLMやタイムアウトなどの設定をenvから取得。GUIでも同じ値を利用。  
- `src/llm/two_pass.py`: LLM整形ロジックはすべてここに閉じ込め、UI層からは触らない。  

---

## アーキテクチャ設計

### 1. ディレクトリ構造

```text
src/
├── cli/
│   └── main.py              # Typer CLI（run / cleanup / gui）
├── pipeline/
│   └── poc.py               # 音声→LLM整形→SRT出力の中核ロジック
├── gui/
│   ├── __init__.py
│   ├── app.py               # Tkinterメインウィンドウ（MainWindow / run_gui）
│   ├── controller.py        # GuiController: execute_poc_run をバックグラウンドで実行
│   └── README.md            # GUIモジュールの説明と起動方法
└── llm/, transcribe/, alignment/ ...  # 既存ロジック（触らない）
```

### 2. データフロー

```text
GUI(MainWindow)
  ├─ ファイル選択ダイアログで audio_path を取得
  ├─ 保存先フォルダ（subtitle_dir）をUIで指定（未指定なら output/）
  └─ GuiController.run_pipeline(audio_path, subtitle_dir, callbacks...)
         │
         ├─ ensure_audio_files()
         ├─ resolve_models()
         ├─ execute_poc_run()
         └─ SRTファイル出力 + 進捗JSON出力
```

GUI は「入力パラメータの収集」と「状態表示」に専念し、処理本体は `execute_poc_run` に任せる。

### 3. 主要コンポーネント

- **`MainWindow` (`src/gui/app.py`)**  
  - 役割: ユーザーに見えるウィンドウ（ファイル選択・保存先選択・実行・ステータス表示）。  
  - 主な要素:  
    - ラベル: 選択中の音声ファイルパス / 保存先フォルダ  
    - ボタン: 「ファイルを選択」「保存先を変更」「実行」  
    - プログレスバー: インジケータ表示（処理中かどうか）  
    - ステータスラベル: 状態メッセージ表示  

- **`GuiController` (`src/gui/controller.py`)**  
  - 役割: GUIからパイプラインを別スレッドで実行し、完了時にコールバックを呼ぶ。  
  - 責務:  
    - `PocRunOptions` の構築（simulate=False / subtitle_dir反映）  
    - `execute_poc_run` の呼び出し  
    - 実行中・完了時のコールバックをUIスレッドで呼び出す（`ui_dispatch`利用）  

---

## 実装フェーズ

### Phase 0: 事前準備・設計
- [x] 要件定義書（`docs/requirement.md`）と既存PLANの確認  
- [x] GUIフェーズ用PLAN（本ドキュメント）の作成・テンプレート適用  
- [x] python.org版3.12 + Tkinterを前提とする方針決定  

### Phase 1: 最小GUI（ファイル選択＋実行ボタン＋保存先選択）
- [x] `src/gui/app.py` 実装 - MainWindow（ファイル選択・保存先選択・実行ボタン・ステータス・プログレスバー）  
- [x] `src/gui/controller.py` 実装 - GuiController（バックグラウンド実行＆SRTパス収集）  
- [x] `src/cli/main.py` に `gui` サブコマンド追加・Tkinter環境チェック実装  
- [x] `src/cli/main.py` に `--subtitle-dir` オプション追加  

**実装のポイント**:
- GUI側ではロジックを持たず、必ず `execute_poc_run` を呼び出す。  
- Tkinter がない環境では `gui` コマンドだけがエラーになり、他のCLIは動作し続けるようにガードする。  

### Phase 2: ステータス詳細化（工程別表示）
- [ ] パイプライン内のログ・進捗情報（音声解析 / LLM整形 / SRT出力）をGUIに反映する設計を決める。  
- [ ] GUIステータスを「音声解析中…」「AI思考中…」「ファイル生成中」に分けて表示。  
- [ ] 長尺音声でのUXを軽く検証（ステータスの変化タイミングが分かるか）。  

### Phase 3: オプションUI追加
- [ ] リライトON/OFFチェックボックス → `rewrite` に連動。  
- [ ] LLMプロバイダー選択プルダウン（google / openai / anthropic） → `--llm` 相当。  
- [ ] 高精度モードON/OFF → `models` / ランナー構成に連動（詳細は別途設計）。  

### Phase 4: Web UI / パッケージング検討
- [ ] FastAPIなどで `execute_poc_run` を包むAPIの設計検討。  
- [ ] Webフロント（簡易画面）を別リポジトリ or `web/` ディレクトリで管理するか決める。  
- [ ] `.app` 化（PyInstaller / py2app など）の下調べと小さなPoC。  

---

## リスクと対応策

| リスク | 内容 | 対応策 |
|-------|------|--------|
| Tkinterが環境依存で動かない | Homebrew版Pythonなどでは `_tkinter` が入っていないケースがある | python.org 版3.12を前提とし、`gui` コマンドでImportErrorを検知してメッセージを出す |
| 長尺音声でGUIが固まって見える | バックグラウンド実行でも、ユーザーからすると何が起きているか分かりにくい | Phase 2で工程別ステータスを実装し、処理段階が分かるようにする |
| 保存先フォルダを間違える | CLI/GUIともにデフォルト `output/` だが、ユーザーが別フォルダを指定して迷子になる可能性 | GUIでは保存先ラベルを常に表示し、CLIでもPRやREADMEで保存先の例を明記する |
| .app 化時のトラブル | Gatekeeper 等でアプリが開けない | パッケージングは別フェーズとし、まず開発環境でのGUI安定稼働を優先する |

---

## 完了条件

### 機能要件
- [ ] `python -m src.cli.main gui` でTkinterウィンドウが起動する。  
- [ ] GUIから音声ファイルを選択→実行ボタンでSRTが生成される（デフォルト `output/` または指定フォルダ）。  
- [ ] CLIから `--subtitle-dir` を指定した場合も、指定フォルダにSRTが出力される。  
- [ ] エラー発生時に分かりやすいメッセージがGUIに表示される。  

### 品質要件
- [ ] GUI経由でもCLIと同じtwo-pass整形ロジックが使われる（SRT品質が一致）。  
- [ ] Tkinter環境が無い場合でもCLIの他コマンド（`run`, `cleanup`）は問題なく動作する。  

### ドキュメント
- [ ] `docs/requirement.md` が実装内容に追従している。  
- [ ] 本PLAN（`docs/plan/20251125_PLAN1.md`）が最新状態になっている。  

---

## 🐛 トラブルシューティング・既知の問題

### エラー1: `_tkinter` が見つからない
**症状**: `ModuleNotFoundError: No module named '_tkinter'` が出てGUIが起動しない。  
**原因**: Homebrew版Pythonなど、Tkinter未同梱のPythonで仮想環境を作成している。  
**解決策**: python.org 版3.12をインストールし、そのPythonでvenvを作り直す。  
**参考**: `src/cli/main.py` 内の `launch_gui` でエラーメッセージを出す。  

### 注意ポイント1: 実行ボタンの連打
**問題**: 実行ボタンを連打すると複数スレッドが立ち上がり、結果が混ざる可能性。  
**対応**: 実行中は `run_button` を無効化し、完了後に再度有効化する実装済み。  
**影響ファイル**: `src/gui/app.py`, `src/gui/controller.py`  

---

## 参考リソース

### 公式ドキュメント
- Tkinter / ttk 基本: Python公式ドキュメント（`tkinter` モジュール）  
- FlowCut Runbook: `docs/runbook.md`  

### 関連プランドキュメント
- `docs/00_old/20251124_PLAN1.md`（OpenAI LLM SRT部分出力バグ修正）  
- `docs/00_old/20251125_PLAN1.md`（LLMプロンプトワークフロー切り替え機能）  

---

## 開発引き継ぎ詳細

### 📌 承認内容
- [x] GUIはまず Tkinter で最小構成を作り、将来必要なら customtkinter / Flet / Web UI でリッチ化する。  
- [x] ロジックは `execute_poc_run` に集約し、UI層では再実装しない。  

### 🗂️ プロジェクト状態
- **技術スタック**: Python 3.12（python.org） / Typer CLI / Tkinter GUI / MLX Whisper / Two-pass LLM整形  
- **動作確認済み機能**: CLIベースの文字起こし〜SRT生成、Tkinter最小GUIからの実行  
- **既知の問題**: 長尺音声でのUX改善（工程別ステータス表示）は今後のPhaseで対応予定。  

### 🚀 実装優先順位

1. **Phase 2** - 理由: 「動いていること」が分かるだけでなく「どの段階か」も見えるようにして不安を減らすため  
2. **Phase 3** - 理由: LLMやリライト設定をGUIから切り替えられると、友人の実運用時に便利なため  
3. **Phase 4** - 理由: Web UIやパッケージングは基盤が安定してからでよい（優先度はCLI/GUIの安定性が先）  

### ⚠️ 重要な注意事項

- GUI実装時は必ず `execute_poc_run` の呼び出し方を変えないようにする（挙動比較がしやすい）。  
- エラー文言はユーザー向けにはやさしい日本語で、詳細はログに任せる。  

---

## 🎯 最終ゴール

**ユーザー体験**:
1. アプリ（スクリプト）を起動する。  
2. 音声ファイルと保存先フォルダをGUI上で選ぶ。  
3. 「実行」ボタンを押すと、ステータスが変化し、処理完了後にSRTファイルの場所が表示される。  

**技術的ゴール**:
- CLI / GUI / 将来のWeb UIが同じパイプラインを通って動作する。  
- Tkinter環境があれば、非エンジニアでもターミナル操作なしで FlowCut を使える。  
- 後からWeb版やパッケージングを追加しても、コアロジックを触らずに済むアーキテクチャになっている。  

---

**実装準備完了！🚀**  
Phase 1 の実装は完了しているので、次は Phase 2（工程別ステータス表示）の詳細設計と実装に進める状態です。  
