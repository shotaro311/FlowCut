# プランニングドキュメント：GUIアプリ（Flow Cut フロントエンド）実装

**作成日**: 2025-11-25  
**バージョン**: 1.0  
**ステータス**: ドラフト  
**前バージョンからの変更**: 新規作成（Phase4 GUIアプリ着手用のPLAN）

※このPLANに着手する前提として、既存の要件定義書 `docs/requirement.md`（特に「4. UI/UX 要件」）を一読していることを想定しています。

---

## ⚡ クイックリファレンス（引き継ぎ用）

> 新規エージェントが3分で状況を把握するためのサマリー

**現在地**: Phase 0 - 「GUI設計・技術選定」ドキュメント作成中（0%完了 / コード未着手）  
**次のアクション**: Tkinterベースで最小GUI（ファイル選択＋実行ボタン＋簡易ログ表示）を実装し、CLIパイプライン `execute_poc_run` をバックグラウンド実行できるようにする。  
**ブロッカー**: なし（Python 3.12 + Tkinter が標準で利用できる前提）  
**重要な決定事項**: 初期実装は **Tkinter + ttk** のシンプルなデスクトップGUIで行い、既存CLIパイプラインをそのまま呼び出す構成とする（Flet / Tauri + React は将来の拡張候補）。

### フェーズ進捗
- [ ] Phase 0: GUI設計・技術選定（このPLANの合意）  
- [ ] Phase 1: 最小GUI（ファイル選択＋実行ボタン＋ログ表示）  
- [ ] Phase 2: 進捗バー・ステータス表示・エラー表示整備  
- [ ] Phase 3: オプションUI（リライトON/OFF・高精度モードなど）  
- [ ] Phase 4: パッケージング準備（.app配布想定）とドキュメント更新  

### 環境チェックリスト
- [ ] Python 3.10〜3.12 + Tkinter 利用可能（macOS 標準）  
- [ ] `.venv` 作成済み ＆ `requirements-dev.txt` 導入済み  
- [ ] `.env` 設定済み（少なくとも LLM用 API キー / Whisper 設定）  

### 重要なファイルパス
- メインCLI: `src/cli/main.py`  
- パイプライン本体: `src/pipeline/poc.py`  
- 文字起こしランナー: `src/transcribe/*.py`  
- LLM二段階整形: `src/llm/two_pass.py` / `src/llm/prompts.py`  
- SRT生成ユーティリティ: `src/alignment/srt.py`  
- GUI（新規予定）: `src/gui/app.py`, `src/gui/controller.py`, `src/gui/README.md`

---

## 🔄 現在の作業状態

**最終更新**: 2025-11-25 00:00 JST（PLAN作成時点）  
**進捗率**: 0%（GUIコードは未実装／設計のみ）

### 直前の作業
- ✅ 完了: CLIベースの two-pass パイプラインが要件定義どおり動作することを確認（文字起こし〜SRT出力まで）  
- 🔄 作業中: GUI実装用PLAN（本ドキュメント）の作成  
  - 残タスク: 各Phaseのタスク粒度を明確化し、実装時に迷わないレベルまで分解する  
  - 停止位置: 「実装フェーズ」セクションのToDo列挙まで  
- ⏳ 次のタスク: Phase 1 の「最小GUI」の実装に着手する前に、本PLANの内容をユーザーと軽くすり合わせる

### ブロッカー・未解決の問題
- [ ] MacのPython環境で Tkinter が利用可能か（M3 Macデフォルト想定だが、万一無効な場合は Flet などに切り替え検討）  
- [ ] ドラッグ＆ドロップ対応の具体的な実装方式（Tkinter標準 + 補助ライブラリ / 代替UI案）  

### 最近の変更履歴（直近5件）
| 日時 | 変更内容 | 関連ファイル |
|------|---------|-------------|
| 11-25 00:00 | GUIフェーズ用PLANを新規作成 | `docs/plan/20251125_PLAN1.md` |
| 11-24 〜 | OpenAI SRT末尾欠落バグ対応（TwoPassFormatterフォールバック） | `src/llm/two_pass.py`, `docs/00_old/20251124_PLAN1.md` |
| 11-23 | Two-pass固定化・旧アンカー方式撤去 | `src/llm/*`, `README_REFRACTORING_SUMMARY.md` |

---

## 💭 主要な意思決定

- **Tkinter採用（初期GUI）**: 追加ライブラリ不要で macOS でも標準利用でき、まず「動くデスクトップアプリ」を短期間で用意しやすいため（代替案: Flet / Tauri + React は将来のリッチUI候補として温存）。  
- **CLIパイプラインの再利用**: 既存の `execute_poc_run` / `PocRunOptions` をそのまま利用し、GUI側では「パラメータを集めて別スレッドで実行する薄い層」にとどめる（ロジックの二重実装を避ける）。  
- **シンプルな単一ウィンドウ構成**: 画面は「ファイル選択エリア＋実行ボタン＋進捗バー＋ログテキスト」の1画面に抑え、非エンジニアユーザーが迷わないレイアウトを優先する。  

---

## 📝 変更済みファイル

| ファイルパス | 状態 | 変更内容 | 影響範囲 | 関連Phase |
|-------------|------|---------|----------|-----------|
| `docs/plan/20251125_PLAN1.md` | 🔄 作業中 | GUI実装用PLANの新規作成 | ドキュメントのみ | Phase 0 |
| `src/gui/app.py` | ⏳ 未着手 | Tkinterベースのメインウィンドウ実装 | GUIレイヤー | Phase 1 |
| `src/gui/controller.py` | ⏳ 未着手 | CLIパイプライン呼び出し・スレッド管理 | GUI⇔パイプライン連携 | Phase 1〜2 |
| `src/gui/README.md` | ⏳ 未着手 | GUIモジュールの責務と起動方法の説明 | 開発者向けドキュメント | Phase 0〜4 |

---

## 📋 目次

1. [要件概要](#要件概要)  
2. [技術選定](#技術選定)  
3. [アーキテクチャ設計](#アーキテクチャ設計)  
4. [実装フェーズ](#実装フェーズ)  
5. [リスクと対応策](#リスクと対応策)  
6. [完了条件](#完了条件)  
7. [🐛 トラブルシューティング・既知の問題](#-トラブルシューティング既知の問題)  
8. [参考リソース](#参考リソース)  
9. [開発引き継ぎ詳細](#開発引き継ぎ詳細)  
10. [最終ゴール](#-最終ゴール)  

---

## 要件概要

### 背景・目的
現在は CLI からコマンドを実行することで音声→SRT 生成が可能だが、非エンジニアユーザー（友人）にとっては「ターミナル操作」が心理的ハードルになっている。  
このフェーズでは、**ドラッグ＆ドロップまたはファイル選択だけで処理を実行できる簡単なデスクトップアプリ**を用意し、日常的に迷わず使える体験を提供する。

### 実装する機能
- **[GUI起動]**: ダブルクリック or `python -m src.cli.main gui` で起動できる単一ウィンドウのGUI。  
- **[ファイル入力]**: 音声ファイルをファイル選択ダイアログ（将来的にはドラッグ＆ドロップ対応）で指定できる。  
- **[実行ボタン]**: 「実行」ボタンを押すと、既存パイプラインを呼び出して文字起こし〜SRT生成を行う。  
- **[進捗表示]**: 「音声解析中…」「AI思考中…」「ファイル生成中…」のステータスと進捗バーを表示。  
- **[結果パスの案内]**: 処理完了後に、生成された SRT ファイルの保存場所（`output/` 下）をGUI上で分かりやすく表示。  

### スコープ外
- 3モデル（mlx / kotoba / openai）の詳細な切り替えUI（初期版ではデフォルト設定優先）。  
- GUI上での詳細ログ閲覧機能（CLIログは従来どおりファイルに保存）。  
- .app への完全パッケージングやインストーラー配布（Phase 4 で検討）。  

---

## 技術選定

### 新規導入ライブラリ

現時点では **Tkinter（標準ライブラリ）＋ ttk** の利用のみを想定し、追加の外部GUIライブラリは導入しない方針とする。

| ライブラリ | バージョン | 選定理由 |
|-----------|-----------|---------|
| `tkinter` / `ttk` | Python標準 | 追加インストール不要で macOS 上でも利用しやすく、最小限のGUIを素早く構築できるため |

※ 将来的に UI をモダンにしたい場合は、`customtkinter` や Flet などを別PLANとして検討する。  
※ ブラウザで動く Web アプリ版を作りたくなった場合は、「Tkinter を捨てて作り直す」のではなく、既存の `execute_poc_run` などのコア処理をそのまま FastAPI 等のAPIから呼び出す構成を想定しておく（= Tkinter はあくまで「最初の入口」の1つ）。 

### 既存ライブラリの活用
- `src/pipeline/poc.py`: 既存の `execute_poc_run` / `PocRunOptions` を GUI から直接呼び出し、ロジックを再利用。  
- `src/utils/progress.py`: 進捗JSONの仕組みはそのまま利用し、GUI側のステータス表示に一部反映する可能性あり。  
- `src/llm/two_pass.py`: LLM整形は既存の two-pass フローをそのまま利用（GUIからはオプションのみ制御）。  

---

## アーキテクチャ設計

### 1. ディレクトリ構造（GUI関連）

```text
src/
├── cli/
│   └── main.py              # 既存CLI（run / cleanup / gui サブコマンド）
├── pipeline/
│   └── poc.py               # 音声→LLM整形→SRT出力の中核ロジック
├── gui/
│   ├── __init__.py          # GUIパッケージ初期化
│   ├── app.py               # Tkinter エントリーポイント（MainWindow定義）
│   ├── controller.py        # GUIからパイプラインを呼ぶコントローラ（別スレッド実行）
│   └── README.md            # GUIモジュールの概要と起動方法
└── alignment/
    └── srt.py               # SubtitleSegment → SRT 変換ユーティリティ
```

### 2. データフロー

```text
GUI(MainWindow) → Controller → execute_poc_run(PocRunOptions) → TwoPassFormatter → SRTファイル出力
                    │
                    └→ GUIへ進捗・完了イベントをコールバック
```

ポイント:
- GUIスレッドは画面更新のみに専念し、パイプライン実行は `threading.Thread` などでバックグラウンド実行。  
- 実行中は「実行ボタンを無効化」「キャンセルボタンは別Phaseで検討」とし、誤操作を防ぐ。  
 - 将来 Web アプリ版を作る場合は、`Controller` 相当の役割を持つ「Web用API（例: FastAPIのエンドポイント）」を追加し、同じ `execute_poc_run` を呼び出すだけで済むようにする（GUIごとにロジックを書き直さない）。

### 3. 主要コンポーネント

- **`MainWindow`（Tkinter）**:  
  - 役割: ファイル選択エリア、実行ボタン、進捗バー、簡易ログラベルを配置するメインウィンドウ。  
  - 主な要素: ファイルパス表示ラベル、`実行`ボタン、`進捗バー(ttk.Progressbar)`, ステータステキスト。  

- **`GuiController`**（controller.py）:  
  - 役割: `execute_poc_run` を別スレッドで呼び出し、進捗状況・完了・エラーを GUI に通知する。  
  - 主なメソッド: `run_pipeline(audio_path, options, callbacks)`。  

---

## 実装フェーズ

### Phase 0: 事前準備・設計（0.5日）
- [ ] 本PLANの内容をユーザーと軽く確認し、「Tkinterベースで最小GUIから着手」方針を合意する。  
- [ ] `src/gui/README.md` に、GUIモジュールの目的と簡単なアーキテクチャを記述。  

### Phase 1: 最小GUI（ファイル選択＋実行ボタン）（1日）
- [ ] `src/gui/app.py` に Tkinter メインウィンドウを実装。  
  - [ ] ファイル選択ボタン（`tkinter.filedialog.askopenfilename`）で音声ファイルを選択。  
  - [ ] 選択済みファイルパスをラベルで表示。  
- [ ] `src/gui/controller.py` を追加し、`execute_poc_run` を別スレッドから呼び出せるようにする。  
- [ ] CLI に `gui` サブコマンドを追加し、`python -m src.cli.main gui` でGUIを起動できるようにする。  

**実装のポイント**:
- GUIからパイプラインを呼ぶ際も、`PocRunOptions` を通して既存オプション構造を尊重する。  
- 初期版ではエラーメッセージを簡潔なダイアログ（`messagebox.showerror`）で表示する。  

### Phase 2: 進捗バー・ステータス表示（1日）
- [ ] パイプライン実行中に、GUI上で「音声解析中…」「AI思考中…」「ファイル生成中…」のステータスを表示。  
  - （実装案）パイプライン実行前後／SRT書き出し前後で Controller から GUI にイベント通知。  
- [ ] 簡易な進捗バー（インジターミネイトでも可）を追加。  
- [ ] 実行完了時に、生成された SRT ファイルのパスと「完了しました」メッセージを表示。  

### Phase 3: オプションUI追加（1〜2日）
- [ ] 「語尾調整・リライトを行う」チェックボックス → `rewrite` オプションに連動。  
- [ ] 「高精度モード（large-v3）」チェックボックス → `models` / ランナー設定に連動（詳細はCLI仕様と同期）。  
- [ ] LLMプロバイダー（`--llm`）の選択UI（Google/OpenAI/Anthropic）を導入するか検討し、必須であればプルダウンで実装。  

### Phase 4: パッケージング・ドキュメント（1〜2日）
- [ ] `docs/runbook.md` に GUI 起動方法を追記。  
- [ ] `.app` 化の方針検討（py2app / PyInstaller など）と、別PLANへの切り出しの要否を決定。  
- [ ] 友人向け「使い方ガイド」（スクリーンショット付き）を簡易に作成。  

**合計見積もり**: 3〜5日（GUIの見た目やオプションの範囲により変動）  

---

## リスクと対応策

| リスク | 内容 | 対応策 |
|-------|------|--------|
| **Tkinterの見た目が素朴すぎる** | UIが古く感じられ、長期的には使いづらい可能性 | 初期版は機能優先で割り切り、後から customtkinter / Flet などで「見た目改善PLAN」を別途立てる |
| **処理中にGUIが固まる** | 音声処理が重く、メインスレッドをブロックするとウィンドウがフリーズする | パイプラインは必ず別スレッドで実行し、GUI側はイベント駆動＋`after` で状態更新する |
| **ドラッグ＆ドロップ実装の難易度** | Tkinter標準だけでは D&D のUXが限定的 | 初期版では「ファイル選択ボタン」で代替し、D&Dは Phase 3 以降で段階的に導入（必要ならサードパーティ利用も検討） |
| **macOS特有の制約** | Gatekeeper や .app 化時の設定で動かないケース | パッケージングはPhase4の別タスクとし、まずは「開発環境でGUIが動く」状態を優先する |

---

## 完了条件

### 機能要件
- [ ] GUI起動が `python -m src.cli.main gui` で行える。  
- [ ] GUI上で音声ファイルを選択し、「実行」ボタンだけでSRTが生成される。  
- [ ] 処理中にステータス表示（最低3ステップ: 音声解析中 / AI思考中 / ファイル生成中）が更新される。  
- [ ] エラー発生時に、ユーザーが理解しやすいメッセージ（例: 「ネットワークエラーが発生しました」）がダイアログで表示される。  

### 品質要件
- [ ] 既存CLIと同じSRT品質（1行17文字以内＋自然な区切り）を維持。  
- [ ] GUI操作で CLI 側の挙動が壊れていない（既存CLIコマンドも問題なく動作）。  
- [ ] Python実行時にGUI関連の例外がコンソールに大量に出ない。  

### ドキュメント
- [ ] `docs/runbook.md` に GUI 起動手順を追記。  
- [ ] `src/gui/README.md` に構成と責務を書き残す。  

---

## 🐛 トラブルシューティング・既知の問題

### 想定されるトラブル例（草案）

#### エラー1: GUIが起動しない（Tkinter関連エラー）
**症状**: `ModuleNotFoundError: No module named 'tkinter'` などがコンソールに出る。  
**原因**: Pythonのインストールに Tkinter が含まれていない、または無効化されている。  
**解決策**: macOS の Python を公式サイト版に切り替える、または Tkinter を含むPythonを再インストールする。  
**参考**: `src/gui/README.md` に環境構築メモを追記予定。  

#### 注意ポイント1: 音声処理中の連打
**問題**: 実行ボタンを連打すると、複数スレッドが走り予期しない挙動になる可能性。  
**対応**: 実行中はボタンを無効化し、完了後に再度有効化する。  
**影響ファイル**: `src/gui/app.py`, `src/gui/controller.py`  

---

## 参考リソース

### 公式ドキュメント・リファレンス
- Tkinter / ttk 基本: Python公式ドキュメント（`tkinter` モジュール）  
- 既存プロジェクトRunbook: `docs/runbook.md`  

### 関連プランドキュメント
- `docs/00_old/20251124_PLAN1.md`（OpenAI LLM SRT部分出力バグ修正）  
- `docs/00_old/20251125_PLAN1.md`（LLMプロンプトワークフロー切り替え機能）  

---

## 開発引き継ぎ詳細

### 📌 承認内容（想定）
- [ ] GUIはまず Tkinter で最小構成を作り、後から見た目改善を検討する。  
- [ ] ロジックは必ず `execute_poc_run` を経由して呼び出し、CLIとGUIで処理内容を揃える。  

### 🗂️ プロジェクト状態
- **技術スタック**: Python 3.12 / Typer CLI / Tkinter GUI / MLX Whisper / Two-pass LLM整形  
- **動作確認済み機能**: CLIベースの文字起こし〜SRT生成（two-pass固定）  
- **既知の問題**: 長尺音声時のUX（時間がかかる間の体験）は今後GUIで改善予定。  

### 🚀 実装優先順位

1. **Phase 1** - 理由: 「とりあえず使えるGUI」を最短で提供するため  
2. **Phase 2** - 理由: 進捗表示がないと長尺処理で不安になるため  
3. **Phase 3** - 理由: リライト・高精度モードなどのオプションは利便性向上フェーズとして後追いで実装  

### ⚠️ 重要な注意事項

- **CLIとの整合性**: GUI独自のロジックを増やしすぎず、常にCLIルートと挙動を比較できるようにする。  
- **エラー表示**: スタックトレースは開発者向けログに留め、ユーザーには要約したメッセージだけを見せる。  

---

## 🎯 最終ゴール

**ユーザー体験（友人視点）**:
1. アプリ（またはスクリプト）を開く。  
2. 音声ファイルを選択して「実行」ボタンを押す。  
3. 少し待つと、「完了しました」と表示され、同じフォルダ内（または `output/`）にSRTが生成されている。  

**技術的ゴール**:
- GUIからの操作でも、CLIと同じ品質のSRTを安定して生成できる。  
- Two-pass LLM整形やメトリクス収集など、既存のバックエンド機能をそのまま活かした構成になっている。  
- 将来的な見た目改善（customtkinter / Flet / Tauri など）や .app 化にスムーズに発展できる土台が整っている。  

---

**実装準備完了！🚀**  
このPLANをベースに、次ステップとして Phase 1（最小GUI）のコード実装に着手できます。ユーザーの確認後、ブランチ作成・Draft PR 作成フローに進んでください。  
