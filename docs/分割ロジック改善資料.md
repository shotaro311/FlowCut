# 字幕自動生成システム改善仕様書 (2025-11-21 Optimized)

## 1. 概要

本ドキュメントは、Whisperによる正確な文字起こしと、LLMによる自然な文脈区切りを組み合わせ、プロ品質のテロップ（字幕）を自動生成するシステムの改善方針を定義する。

コアコンセプト:

「機械的な分割（Blocking）」は最小限に留め、「意味的な分割（LLM）」に全権を委ねる。 Python側はエラーハンドリング（Safety Net）と高精度な時間同期（Alignment）に徹することで、読みやすさと正確性を両立させる。

## 2. 処理フロー概要（Blocking無効化版）

1. **LLM Processing (Formatting):** Whisperが出した全文をそのままLLMに渡し、意味的な改行と整形を行う（Chunk分割なし）。
2. **Post-processing (Validation):** LLMの出力がルール（17文字等）を守れているか検査し、必要なら補正する。
3. **Alignment:** 整形されたテキストと元のタイムスタンプを同期させる。

---

## 3. 各フェーズ詳細仕様

### Phase 1: LLM Formatting (中核処理)

本システムの要。単一のAPIコールで、思考プロセスを含めた高度な整形を行わせる。

- **使用モデル:** Gemini 1.5 Pro, GPT-4o 等（Context Windowが広く、指示従順性が高いモデル推奨）
    
- **実行方式:** Single-shot（一括処理）。長尺動画の場合はPython側でブロック単位（例: 5分ごと）に並列リクエストを行う。
    
- **プロンプト:** 以下の「思考ワークフロー強制型プロンプト」を使用する。
    

#### 実装用プロンプト

Markdown

```
# Role
あなたは熟練の動画テロップ編集者です。
提供されたテキストを、視聴者が最も読みやすいリズムで読めるように、以下の【思考ワークフロー】に従って厳密に処理し、整形後のテキストのみを出力してください。

# Constraints (制約)
- 1行の最大文字数：全角17文字
- 出力形式：整形後のテキストのみ（改行区切り）
- 禁止事項：行末の句読点（、。）は必ず削除すること。文中の句読点は残してもよい。

# Thinking Workflow (思考ワークフロー)
あなたは内部的に以下のステップ順で処理を行ってください。

## Step 1: チャンク分解 (Chunking)
入力されたテキストを、文節や意味の最小単位（チャンク）に分解します。
また、句読点（、。）や接続助詞（〜て、〜が、〜ので、〜から）を「区切りの強いポイント」として認識します。

## Step 2: 行の構築と決定 (Line Building)
分解したチャンクを前から順にバッファ（現在の行）に追加していきます。追加するたびに以下の【判定ロジック】を実行します。

**【判定ロジック】**
1. **文字数オーバー判定**: 
   - 「現在のバッファ」＋「次のチャンク」が17文字を超える場合
   → 現在のバッファを1行として確定（改行）。次のチャンクは新しい行へ。

2. **文脈区切り判定 (最重要)**:
   - 文字数が17文字以内であっても、現在のチャンクが「読点（、）」や「強い文の切れ目（〜ます、〜です、〜だ）」、または「接続助詞（〜から、〜けど）」で終わっている場合
   → **無理に繋げず、そこで行を確定（改行）する。**
   （例：「何もないから」で6文字だが、「から」で意味が切れるのでそこで改行する）

## Step 3: クリーニング (Cleaning)
確定した行の**末尾**に句読点（、。）がある場合、それを取り除きます。
（例：「地盤、看板、鞄が」→そのまま。「何もないから、」→「何もないから」）

# Examples (処理の理想形)

## Input
3月末に、一回家帰ってこいって言われて帰ったら実家の親が食品スーパーを20年間経営してたんですけどその経営状態が悪くて1億円近い借金ができてるということがカミングアウトされてどうするの？と話をしたら今の状態でお金返せないから自分は高額の生命保険を何かあったらいけないと思ってかけてあったからそれが出れば借金は帳消しになるからそれがもし出たらお前がちゃんとやってくれないかみたいなことを言われて

## Good Output (文脈とリズムを優先)
3月末に、一回家帰ってこいって
言われて帰ったら
実家の親が食品スーパーを
20年間経営してたんですけど
その経営状態が悪くて
1億円近い借金ができてるということが
カミングアウトされて
どうするの？
と話をしたら
今の状態でお金返せないから
自分は高額の生命保険を
何かあったらいけないと思って
かけてあったから
それが出れば借金は
帳消しになるから
それがもし出たら
お前がちゃんとやってくれないか
みたいなことを言われて

## Bad Output (NG例：文字数詰め込みすぎ・句読点残り)
3月末に一回家帰ってこいって言われて
帰ったら実家の親が食品スーパーを
20年間経営してたんですけどその
経営状態が悪くて1億円近い借金が
できてるということがカミングアウト
されて、どうするのと話をしたら
今の状態でお金返せないから自分は
高額の生命保険を何かあったら
いけないと思ってかけてあったから
それが出れば借金は帳消しになるから、
それがもし出たらお前がちゃんと
やってくれないかみたいなことを言われて

# User Input
(ここにWhisper等で書き起こしたテキストを入力)
```

### Phase 2: Validation & Fallback (後処理・安全装置)

LLMがルール（17文字制限など）を破った場合の補正をPython側で行う。

- **バリデーション:** 出力された各行の文字数をチェック。
    
- **フォールバック処理:** 17文字を超えている行があれば、以下の優先順位で強制改行を入れる。
    
    1. 読点（、）
        
    2. 主要な助詞（は、が、を、に、で、て）の後ろ
        
    3. 行の中央（最終手段）
        

### Phase 3: Alignment (時間同期)

LLM生成テキスト（整形済み）と、Whisperの単語レベルタイムスタンプ（JSON）を突き合わせる。

- **アルゴリズム:** アンカー方式（Anchor-based Alignment）
    
    - **概要:** LLMテキスト内の単語とJSON内の単語を照合し、**「確実に一致する単語（アンカー）」**を特定する。
        
    - **誤字対策:** 完全一致ではなく、Levenshtein距離などを用いたファジーマッチング（あいまい検索）を導入し、LLMによる誤字修正（例：夕日原→将来）があっても、前後の文脈から時間を推定できるようにする。
        
    - **補間:** アンカーとアンカーの間のテキストについては、経過時間を文字数比率などで配分してタイムスタンプを割り当てる。
        

---

## 4. 期待される効果

- **品質向上:** 息継ぎや意味の切れ目で適切に改行された、読みやすいテロップが生成される。
    
- **堅牢性:** LLMがハルシネーションを起こしたり、ルールを破ったりしても、Python側のバリデーションとアンカー方式のアライメントにより、システムエラーを防ぎつつ時間を同期できる。
    
- **効率:** プロンプトエンジニアリングによりLLMへのリクエスト回数を最小限に抑え、コストと速度を最適化する。
