# 字幕分割ロジック改善メモ（2025-11-21）

目的: `samples/20251121T141838_修正イメージ.md` の粒度（短い意味単位）で最終SRTを出力できるようにする。タイムスタンプ精度より、まずテキスト区切り品質を最優先で揃える。

## 現状の課題（sample_audio_openai_20251121T141838.srt）
- 句読点が少ない長文が1ブロック化 → 行が過度に長尺（最大206秒）。
- BlockSplitter が「1200文字/30秒」上限を突破しても切れないケースがある。
- LLM整形後の行長は17文字以内だが、改行位置が粗く、理想台本より行数が11行少ない（文結合が発生）。

## 改善方針（テキスト区切り中心）
1. **強制分割（OR条件厳格化）**  
   - 1200文字または30秒に達したら無条件でブロックを確定。句読点が無くても切る。  
   - ブロック末尾の1〜2文を次ブロック先頭へオーバーラップコピー（現行踏襲）。

2. **句読点が乏しい場合の補助ルール**  
   - 連続トークン長やスペース位置で暫定境界を入れる（例: 80〜100字ごとにソフトカット候補）。  
   - ソフトカットは「上限超過時の即時ハードカット」を保証する安全弁として扱う。

3. **LLM整形時のプロンプト/バリデーション強化**  
   - 改行ポリシーを明示: 「助詞・読点・意味の切れ目で最優先に改行、17文字以内厳守」。  
   - 生成後に再検証し、17文字超は自動再分割（既存機能を厳格化）。

4. **アライメント前の行長ガード**  
   - LLM出力行をアラインする際、1行あたりの再生時間上限を設定（例: 6秒）。  
   - 上限超えが推定されたら、行内でさらに再分割してからアライン。

5. **評価指標（最低限）**  
   - char_violation_blocks = 0, duration_violation_blocks = 0 を目標。  
   - 行平均長: 修正イメージに近似（10〜12文字幅）。  
   - 句読点なし音声での強制カット有無のユニットテスト追加。

## 実装ステップ案
- `src/blocking/splitter.py`
  - duration/文字数が閾値を超えたら即 finalize_block。  
  - 句読点希薄時のソフトカットしきい値を追加（オプション化）。
- `src/llm/formatter.py`
  - プロンプトに改行優先ルールを明記。  
  - 17文字超の再分割をより細かいヒューリスティックで行う（読点→助詞→均等分割）。
- `src/alignment/timestamp.py`
  - 行ごとの最大許容再生時間をクランプ（例: start + 6.0s まで）。  
  - アンカー探索のウィンドウを直近 N 語（例: 80語）に制限し、遠距離マッチを避ける。
- テスト
  - 句読点なし長文を入力し、`num_blocks > 1` となることを確認するUTを追加。  
  - 17文字超が再分割されることを確認するUTを追加。  
  - 行再生時間が上限を超えないことを確認するUTを追加。

## メモ
- 理想台本（修正イメージ）をゴール指標にし、行数・平均文字幅・max行長で回帰チェックする。  
- タイムスタンプ調整は「テキスト区切り安定化」後に再評価する。
