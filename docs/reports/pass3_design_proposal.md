# SRTç¬¬3æ¬¡æ¤œè¨¼ & Pass 3è¨­è¨ˆææ¡ˆ

**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `output/sample_audio_mlx_20251123T155046.srt`
**ä½œæˆæ—¥**: 2025-11-23
**ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç‰ˆ**: Pass 2ç¬¬2æ¬¡ä¿®æ­£ç‰ˆï¼ˆçµ‚åŠ©è©ãƒ»æ¥ç¶šè©è¿½åŠ ã€æœ€å°4æ–‡å­—ï¼‰

---

## ğŸ“Š ç¬¬2æ¬¡ä¿®æ­£å¾Œã®çµæœ

### âœ… æ”¹å–„ã•ã‚ŒãŸç‚¹
- å‰å›å•é¡Œè¦–ã—ã¦ã„ãŸã€Œã‚ˆã€å˜ç‹¬è¡Œ â†’ **è§£æ±º**ï¼ˆè¡Œ145ã§ã€Œé•·è°·å·å…ˆç”Ÿã ã£ãŸã¨æ€ã„ã¾ã™ã‚ˆã€ã¨ã—ã¦æ­£ã—ãä¿æŒï¼‰
- å‰å›å•é¡Œè¦–ã—ã¦ã„ãŸã€Œã‚“ã§ã€å˜ç‹¬è¡Œ â†’ **è§£æ±º**ï¼ˆè¡Œ73ã§ã€Œæ€–ã‹ã£ãŸã‚“ã§ã€ã¨ã—ã¦æ­£ã—ãä¿æŒï¼‰
- å¼•ç”¨ã€Œã£ã¦ã€ã®åˆ†å‰²ã‚‚å¤§å¹…ã«æ”¹å–„

### âš ï¸ æ®‹å­˜ã™ã‚‹å•é¡Œï¼ˆã‚±ã‚¢ãƒ¬ã‚¹ãƒŸã‚¹ï¼‰

| ID | è¡Œç•ªå· | æ™‚é–“ | å•é¡Œå†…å®¹ | å•é¡Œã®ç¨®é¡ |
| :--- | :--- | :--- | :--- | :--- |
| R2 | 43-44 | 01:21ã€œ01:26 | ã€Œ1å„„å††è¿‘ã„å€Ÿé‡‘ãŒã§ãã¦ã‚‹ã¨ã„ã†ã“ã¨ã€â†’ã€Œã‚’ã€ï¼ˆ1æ–‡å­—ï¼‰ | åŠ©è©ã€Œã‚’ã€ãŒå˜ç‹¬ |
| R3 | 101-102 | 03:17ã€œ03:20 | ã€Œã¯ã„ä½•ã™ã‚‹ã‚“ã ã£ã¦ã€â†’ã€Œè¨€ã†ã‹ã‚‰ã€ | å¼•ç”¨è¡¨ç¾ã®åˆ†å‰² |
| R4 | 108-109 | 03:29ã€œ03:30 | ã€Œãªã‚“ã§ã§ã™ã‹ã£ã¦ã€â†’ã€Œè¨€ã£ãŸã‚‰ã€ | å¼•ç”¨è¡¨ç¾ã®åˆ†å‰² |

**å•é¡Œæ•°**: 3ä»¶ï¼ˆR1, R5ã¯å•é¡Œãªã—ã¨åˆ¤æ–­ï¼‰  
**æ”¹å–„ç‡**: å‰å›æŒ‡æ‘˜4ä»¶ â†’ ã»ã¼è§£æ±ºã€æ–°ãŸã«3ä»¶ç™ºè¦‹

**Pass 2å˜ç‹¬ã§ã®ç²¾åº¦**: **ç´„97%**ï¼ˆ3ä»¶ã®ã¿ã®æ®‹å­˜å•é¡Œï¼‰

---

## ğŸ” å•é¡Œã®å‚¾å‘åˆ†æ

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: åŠ©è©ã®å˜ç‹¬è¡Œï¼ˆ1ä»¶ï¼‰
- **R2**: ã€Œã‚’ã€ï¼ˆ1æ–‡å­—ï¼‰ãŒå˜ç‹¬
- **åŸå› **: å‰ã®è¡ŒãŒ17æ–‡å­—ã‚®ãƒªã‚®ãƒªã§ã€ã€Œã‚’ã€ã ã‘æ¬¡è¡Œã«é€ã‚‰ã‚ŒãŸ
- **LLMã®åˆ¤æ–­**: ã€Œ17æ–‡å­—è¶…éã‚’é¿ã‘ã‚‹ > æœ€å°4æ–‡å­—ã€ã®å„ªå…ˆé †ä½ãƒŸã‚¹

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: å¼•ç”¨è¡¨ç¾ã®åˆ†å‰²ï¼ˆ2ä»¶ï¼‰
- **R3, R4**: ã€Œã€œã£ã¦è¨€ã†ã‹ã‚‰ã€ã€Œã€œã£ã¦è¨€ã£ãŸã‚‰ã€
- **åŸå› **: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«æ˜è¨˜ã—ãŸãŒã€LLMãŒä¸€éƒ¨ã§å®ˆã‚Œã¦ã„ãªã„
- **ç¢ºç‡çš„ãªå•é¡Œ**: åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã‚‚ã€ã‚ã‚‹ç®‡æ‰€ã§ã¯å®ˆã‚Œã¦ã€åˆ¥ã®ç®‡æ‰€ã§ã¯å®ˆã‚Œãªã„

**çµè«–**: Pass 3ã§å¯¾å‡¦ã™ã¹ãå•é¡Œã¯ **å®Ÿè³ª3ä»¶ã®ã¿**ï¼ˆR2ã€œR4ï¼‰

---

## ğŸ¯ Pass 3è¨­è¨ˆææ¡ˆ

### æ¡ç”¨æ–¹é‡: **Option Cï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ–¹å¼ï¼‰**

Pass 2ã®å‡ºåŠ›ã«å¯¾ã—ã¦ã€ä»¥ä¸‹ã®2æ®µéšã§ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ï¼š

#### Step 1: ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®å•é¡Œæ¤œå‡ºï¼ˆé«˜é€Ÿãƒ»ç¢ºå®Ÿï¼‰
```python
def detect_issues(lines: List[LineRange], words: List[WordTimestamp]) -> List[Issue]:
    issues = []
    
    # å•é¡Œ1: æ¥µç«¯ã«çŸ­ã„è¡Œï¼ˆ1-3æ–‡å­—ï¼‰
    for i, line in enumerate(lines):
        if len(line.text) < 4:
            issues.append(Issue(type="short_line", line_idx=i, severity="high"))
    
    # å•é¡Œ2: åŠ©è©ã§çµ‚ã‚ã‚‹è¡Œ
    PARTICLES = ["ã‚’", "ã«", "ã§", "ãŒ", "ã¯", "ã‚‚", "ã‹ã‚‰", "ã¾ã§", "ã¸", "ã¨"]
    for i, line in enumerate(lines):
        if line.text[-1] in PARTICLES:
            issues.append(Issue(type="ends_with_particle", line_idx=i, severity="medium"))
    
    # å•é¡Œ3: å¼•ç”¨è¡¨ç¾ã®åˆ†å‰²
    QUOTATION_PATTERNS = ["ã£ã¦è¨€", "ã£ã¦æ€", "ã£ã¦ã“ã¨"]
    for i, line in enumerate(lines[:-1]):
        next_line = lines[i+1]
        for pattern in QUOTATION_PATTERNS:
            if line.text.endswith(pattern[:2]) and next_line.text.startswith(pattern[2:]):
                issues.append(Issue(type="split_quotation", line_idx=i, severity="medium"))
    
    return issues
```

#### Step 2: LLMã«ã‚ˆã‚‹ä¿®æ­£ï¼ˆå•é¡ŒãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã®ã¿ï¼‰
```python
def fix_with_llm(lines, words, issues):
    if not issues:
        return lines  # å•é¡Œãªã— â†’ ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã‚³ã‚¹ãƒˆ0ï¼‰
    
    # å•é¡Œç®‡æ‰€ã‚’LLMã«æç¤ºã—ã¦ä¿®æ­£ææ¡ˆã‚’ä¾é ¼
    prompt = build_pass3_prompt(lines, words, issues)
    fixed_lines = call_llm(prompt)
    return fixed_lines
```

### Pass 3ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆï¼ˆæ¡ˆï¼‰

```
# Role
ã‚ãªãŸã¯æœ€çµ‚ãƒã‚§ãƒƒã‚¯æ‹…å½“ã®ç†Ÿç·´ç·¨é›†è€…ã§ã™ã€‚
Pass 2ã§ä½œæˆã•ã‚ŒãŸå­—å¹•ã®è¡Œåˆ†å‰²ã«ã€Œæ˜ã‚‰ã‹ãªé–“é•ã„ã€ãŒãªã„ã‹ç¢ºèªã—ã€å¿…è¦æœ€å°é™ã®ä¿®æ­£ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

# Input
- å˜èªãƒªã‚¹ãƒˆï¼ˆindex:wordï¼‰
- Pass 2ã®è¡Œç¯„å›²ãƒªã‚¹ãƒˆ
- æ¤œå‡ºã•ã‚ŒãŸå•é¡Œãƒªã‚¹ãƒˆ

# Task
ä»¥ä¸‹ã®å•é¡Œã®ã¿ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ï¼ˆãã‚Œä»¥å¤–ã¯å¤‰æ›´ã—ãªã„ï¼‰ï¼š

1. **1ã€œ3æ–‡å­—ã®æ¥µç«¯ã«çŸ­ã„è¡Œ**: å‰è¡Œã¾ãŸã¯æ¬¡è¡Œã¨çµ±åˆ
   ä¾‹: ã€Œã¨ã„ã†ã“ã¨ã€â†’ã€Œã‚’ã€ â†’ ã€Œã¨ã„ã†ã“ã¨ã‚’ã€ã«çµ±åˆ
   
2. **åŠ©è©ã§çµ‚ã‚ã‚‹è¡Œ**: æ¬¡è¡Œã®ä¸€éƒ¨ã‚’å¼•ãå–ã‚‹ã‹ã€å‰è¡Œã¨çµ±åˆ
   ä¾‹: ã€Œå€Ÿé‡‘ãŒã§ãã¦ã‚‹ã¨ã„ã†ã“ã¨ã€â†’ã€Œã‚’ã€ â†’ çµ±åˆ
   
3. **å¼•ç”¨è¡¨ç¾ã®åˆ†å‰²**: ã€Œã€œã£ã¦è¨€ã†ã€ã€Œã€œã£ã¦æ€ã†ã€ã‚’çµ±åˆ
   ä¾‹: ã€Œãªã‚“ã§ã§ã™ã‹ã£ã¦ã€â†’ã€Œè¨€ã£ãŸã‚‰ã€ â†’ ã€Œãªã‚“ã§ã§ã™ã‹ã£ã¦è¨€ã£ãŸã‚‰ã€

# Constraints
- ä¿®æ­£ã¯å•é¡Œç®‡æ‰€ã®ã¿ï¼ˆå…¨ä½“ã‚’ä½œã‚Šç›´ã•ãªã„ï¼‰
- ä¿®æ­£å¾Œã‚‚17æ–‡å­—ä»¥å†…ã‚’ç¶­æŒ
- ä¿®æ­£å¾Œã‚‚4æ–‡å­—ä»¥ä¸Šã‚’ç¶­æŒ
- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¯å¤‰æ›´ã—ãªã„ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã¿ä¿®æ­£ï¼‰

# Output
ä¿®æ­£å¾Œã®è¡Œç¯„å›²ãƒªã‚¹ãƒˆï¼ˆJSONï¼‰
```

---

## ğŸ’¡ å®Ÿè£…ã®æ³¨æ„ç‚¹

### 1. ã‚³ã‚¹ãƒˆæœ€é©åŒ–
- **å•é¡Œãªã—**: LLMå‘¼ã³å‡ºã—2å›ï¼ˆPass 1 + Pass 2ï¼‰
- **å•é¡Œã‚ã‚Š**: LLMå‘¼ã³å‡ºã—3å›ï¼ˆPass 1 + Pass 2 + Pass 3ï¼‰
- **æœŸå¾…å€¤**: å•é¡Œç™ºç”Ÿç‡ã‚’10%ã¨ä»®å®šã™ã‚‹ã¨ã€å¹³å‡2.1å›ã®å‘¼ã³å‡ºã—

### 2. ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®ç¶­æŒ
- Pass 3ã§ã¯ **è¡Œç¯„å›²ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰ã®ã¿ä¿®æ­£**
- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¯æ—¢å­˜ã® `_ranges_to_segments` ã§å†è¨ˆç®—
- ã‚¯ãƒ©ãƒ³ãƒ—å‡¦ç†ã‚‚å¼•ãç¶šãæœ‰åŠ¹

### 3. ä¿®æ­£ã®æœ€å°åŒ–
- Pass 3ã¯ã€Œå•é¡Œç®‡æ‰€ã®ä¿®æ­£ã€ã«ç‰¹åŒ–
- å…¨ä½“ã‚’ä½œã‚Šç›´ã™ã¨ã€æ–°ãŸãªå•é¡Œã‚’ç”Ÿã‚€å¯èƒ½æ€§ãŒã‚ã‚‹
- ã€Œå¿…è¦æœ€å°é™ã®ä¿®æ­£ã€ã‚’æ˜ç¤ºçš„ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å«ã‚ã‚‹

---

## ğŸ“ˆ æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

| æŒ‡æ¨™ | Pass 2ã®ã¿ | Pass 2 + Pass 3 |
| :--- | :--- | :--- |
| åŠ©è©ã§ã®ä¸è‡ªç„¶ãªåˆ†å‰² | 1ä»¶ | 0ä»¶ |
| å¼•ç”¨è¡¨ç¾ã®åˆ†å‰² | 2ä»¶ | 0ä»¶ |
| æ¥µç«¯ã«çŸ­ã„è¡Œ | 0ä»¶ | 0ä»¶ |
| **å…¨ä½“ã®ç²¾åº¦** | **97%** | **99%+** |

---

## ğŸš€ å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

### Phase 1: ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®æ¤œå‡ºå™¨
1. `src/llm/validators.py` ã‚’ä½œæˆ
2. `detect_issues()` é–¢æ•°ã‚’å®Ÿè£…
3. å˜ä½“ãƒ†ã‚¹ãƒˆã§æ¤œè¨¼

### Phase 2: Pass 3ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
1. `_build_pass3_prompt()` ã‚’ `two_pass.py` ã«è¿½åŠ 
2. å•é¡Œãƒªã‚¹ãƒˆã‚’å…¥åŠ›ã¨ã—ã¦å—ã‘å–ã‚‹
3. ä¿®æ­£ææ¡ˆã‚’ JSON ã§è¿”ã™

### Phase 3: çµ±åˆ
1. `TwoPassFormatter.run()` ã‚’æ‹¡å¼µ
2. Pass 2ã®å¾Œã« `detect_issues()` ã‚’å®Ÿè¡Œ
3. å•é¡ŒãŒã‚ã‚Œã° Pass 3ã‚’å®Ÿè¡Œã€ãªã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—

### Phase 4: æ¤œè¨¼
1. æ—¢å­˜ã®ã‚µãƒ³ãƒ—ãƒ«éŸ³å£°ã§ç²¾åº¦å‘ä¸Šã‚’ç¢ºèª
2. ã‚³ã‚¹ãƒˆå¢—åŠ ã‚’æ¸¬å®šï¼ˆå¹³å‡ä½•%ã®éŸ³å£°ã§ Pass 3ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‹ï¼‰

---

## âš™ï¸ ä»£æ›¿æ¡ˆã¨ã®æ¯”è¼ƒ

| æ–¹å¼ | ç²¾åº¦ | ã‚³ã‚¹ãƒˆ | å®Ÿè£…é›£æ˜“åº¦ |
| :--- | :--- | :--- | :--- |
| **ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ï¼ˆæ¨å¥¨ï¼‰** | 99% | ä½ï¼ˆå•é¡Œæ™‚ã®ã¿ï¼‰ | ä¸­ |
| LLMã®ã¿ | 99% | é«˜ï¼ˆå¸¸æ™‚ï¼‰ | ä½ |
| ãƒ«ãƒ¼ãƒ«ã®ã¿ | 90% | 0 | é«˜ |

**çµè«–**: ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ–¹å¼ãŒæœ€ã‚‚ãƒãƒ©ãƒ³ã‚¹ãŒè‰¯ã„
